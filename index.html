<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bonnie SIRA ‚Äî Sistema Inclusivo de Refugio Animal</title>
  <style>
    /* ========== VARIABLES DE TEMA ========== */
    :root{
      --lav:#7a77ff;
      --lav-2:#a6a3ff;
      --cel:#7fd3ff;
      --bg:#f6f7ff;
      --card:#ffffff;
      --ink:#1f2230;
      --muted:#6b6f86;
      --line:#eceefe;
      --radius:16px;
      --shadow:0 10px 30px rgba(35,38,90,.08);
      --success:#10b981;
      --warning:#f59e0b;
      --error:#ef4444;
      
      /* Accesibilidad */
      --focus-ring: 0 0 0 3px rgba(122,119,255,.4);
      --min-touch-size: 44px;
    }

    /* Modo alto contraste */
    @media (prefers-contrast: high) {
      :root {
        --ink: #000000;
        --bg: #ffffff;
        --lav: #0000cc;
      }
    }

    /* Reducir animaciones para usuarios sensibles */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* ========== ESTILOS BASE ========== */
    *{
      box-sizing:border-box;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      line-height: 1.6;
    }
    
    a{color:inherit;text-decoration:none;}
    
    /* Focus visible para navegaci√≥n por teclado */
    *:focus {
      outline: none;
    }
    
    *:focus-visible {
      outline: 3px solid var(--lav);
      outline-offset: 2px;
      box-shadow: var(--focus-ring);
    }

    /* ========== SKIP LINK (Accesibilidad) ========== */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--lav);
      color: white;
      padding: 8px 16px;
      text-decoration: none;
      font-weight: bold;
      z-index: 10000;
    }
    
    .skip-link:focus {
      top: 0;
    }

    /* ========== HEADER ========== */
    header{
      position:sticky;
      top:0;
      z-index:50;
      background:linear-gradient(90deg,var(--lav),var(--cel));
      color:#fff;
      padding:14px 18px;
      box-shadow:0 6px 20px rgba(0,0,0,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.3px;
    }
    
    .paw{
      width:34px;
      height:34px;
      border-radius:10px;
      background:rgba(255,255,255,.18);
      display:grid;
      place-items:center;
      font-size:18px;
      backdrop-filter: blur(4px);
    }
    
    nav{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    
    nav button{
      border:0;
      background:rgba(255,255,255,.14);
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      transition:.2s;
      display:flex;
      align-items:center;
      gap:6px;
      min-height: var(--min-touch-size);
      font-size: 14px;
    }
    
    nav button.active{
      background:#fff;
      color:var(--lav);
    }
    
    nav button:hover{
      transform:translateY(-1px);
      background:rgba(255,255,255,.22);
    }

    /* ========== LAYOUT ========== */
    .wrap{
      max-width:1100px;
      margin:18px auto;
      padding:0 14px 60px;
    }
    
    .grid{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:14px;
    }
    
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }

    /* ========== TIPOGRAF√çA ========== */
    h1 {
      font-size: clamp(1.5rem, 4vw, 2.5rem);
      margin: 0 0 16px;
    }
    
    h2{
      font-size: clamp(1.2rem, 3vw, 1.8rem);
      margin:0 0 10px;
    }
    
    h3{
      font-size:15px;
      margin:6px 0;
      color:#343853;
    }
    
    .muted{
      color:var(--muted);
      font-size:13px;
    }
    
    /* Textos de ayuda */
    .help-text {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px;
      font-style: italic;
    }

    /* ========== COMPONENTES ========== */
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      background:#f2f3ff;
      color:#40446a;
      font-weight:700;
      border:1px solid var(--line);
    }
    
    .row{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    
    .spacer{height:8px;}
    
    /* Botones accesibles */
    .btn{
      border:0;
      background:var(--lav);
      color:#fff;
      padding:12px 16px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      transition:.15s;
      box-shadow:0 6px 14px rgba(122,119,255,.35);
      min-height: var(--min-touch-size);
      font-size: 15px;
      position: relative;
    }
    
    .btn:hover{
      transform:translateY(-1px);
      filter:saturate(1.05);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn.secondary{
      background:#eef0ff;
      color:#3a3f63;
      box-shadow:none;
      border:1px solid var(--line);
    }
    
    .btn.ghost{
      background:transparent;
      color:var(--lav);
      border:2px solid var(--lav);
      box-shadow:none;
    }
    
    .btn.small{
      padding:6px 9px;
      border-radius:10px;
      font-size:12px;
      min-height: 36px;
    }
    
    .btn:disabled{
      opacity:.6;
      cursor:not-allowed;
      transform:none;
    }
    
    /* Loading state */
    .btn.loading::after {
      content: '';
      position: absolute;
      right: 12px;
      width: 16px;
      height: 16px;
      border: 2px solid currentColor;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.6s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ========== FORMULARIOS ACCESIBLES ========== */
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 14px;
    }
    
    label .required {
      color: var(--error);
      font-weight: bold;
    }
    
    input, select, textarea{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid #dfe2fb;
      background:#fcfcff;
      outline:none;
      transition:.15s;
      font-size: 15px;
      min-height: var(--min-touch-size);
    }
    
    input:focus, select:focus, textarea:focus{
      border-color:var(--lav-2);
      box-shadow:0 0 0 4px rgba(122,119,255,.12);
    }
    
    /* Estados de validaci√≥n */
    input.valid, select.valid {
      border-color: var(--success);
    }
    
    input.invalid, select.invalid {
      border-color: var(--error);
    }
    
    .validation-message {
      display: block;
      margin-top: 6px;
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 8px;
    }
    
    .validation-message.success {
      color: var(--success);
      background: #ecfdf5;
      border: 1px solid #d1fae5;
    }
    
    .validation-message.error {
      color: var(--error);
      background: #fef2f2;
      border: 1px solid #fecaca;
    }
    
    .validation-message.warning {
      color: var(--warning);
      background: #fffbeb;
      border: 1px solid #fde68a;
    }

    /* ========== NOTIFICACIONES (Toast) ========== */
    .toast-container {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 9999;
      max-width: 400px;
    }
    
    .toast {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,.15);
      border-left: 4px solid var(--lav);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .toast.success { border-left-color: var(--success); }
    .toast.error { border-left-color: var(--error); }
    .toast.warning { border-left-color: var(--warning); }
    
    .toast-icon {
      font-size: 24px;
      flex-shrink: 0;
    }
    
    .toast-content {
      flex: 1;
    }
    
    .toast-title {
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .toast-message {
      font-size: 14px;
      color: var(--muted);
    }

    /* ========== INDICADOR DE PROGRESO ========== */
    .progress-container {
      background: #f0f0f0;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    
    .progress-bar {
      height: 8px;
      background: linear-gradient(90deg, var(--lav), var(--cel));
      transition: width 0.3s ease;
    }
    
    .progress-label {
      font-size: 13px;
      color: var(--muted);
      margin-top: 6px;
      text-align: center;
    }

    /* ========== TOOLTIPS Y AYUDAS ========== */
    .help-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--lav-2);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
      margin-left: 6px;
      position: relative;
    }
    
    .help-btn:hover::after {
      content: attr(data-help);
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--ink);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: normal;
      white-space: nowrap;
      max-width: 250px;
      white-space: normal;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,.2);
    }

    /* ========== ACCESIBILIDAD - SCREEN READER ONLY ========== */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    /* ========== MODALES ACCESIBLES ========== */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(15,16,30,.6);
      z-index:99;
    }
    
    .modal[aria-hidden="false"] {
      display: flex;
    }
    
    .dialog{
      background:white;
      width:min(560px,92vw);
      border-radius:18px;
      padding:14px;
      border:1px solid var(--line);
      box-shadow:0 20px 60px rgba(0,0,0,.25);
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .dialog header{
      position:unset;
      background:transparent;
      color:var(--ink);
      box-shadow:none;
      padding:0 0 12px;
      display:flex;
      justify-content:space-between;
      border-bottom: 1px solid var(--line);
      margin-bottom: 16px;
    }
    
    .x{
      border:0;
      background:transparent;
      font-size:28px;
      cursor:pointer;
      width: var(--min-touch-size);
      height: var(--min-touch-size);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
    }
    
    .x:hover {
      background: #f3f4f6;
    }

    /* ========== SECCIONES ========== */
    section.hidden{display:none;}
    
    /* ========== AUTO-GUARDADO INDICATOR ========== */
    .auto-save {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      padding: 10px 16px;
      border-radius: 999px;
      box-shadow: 0 4px 12px rgba(0,0,0,.1);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 100;
    }
    
    .auto-save.saving {
      background: #fff7ed;
      color: var(--warning);
    }
    
    .auto-save.saved {
      background: #ecfdf5;
      color: var(--success);
    }

    /* ========== BREADCRUMB ========== */
    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      color: var(--muted);
    }
    
    .breadcrumb a {
      color: var(--lav);
      text-decoration: underline;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width:800px){ 
      .grid{grid-template-columns:repeat(6,1fr);} 
    }
    
    @media (max-width:520px){
      .grid{grid-template-columns:repeat(2,1fr);}
      nav{gap:6px; flex-direction: column; width: 100%;}
      nav button {width: 100%; justify-content: center;}
      .toast-container {
        right: 10px;
        left: 10px;
        max-width: none;
      }
    }

    /* ========== MODO SIMPLIFICADO ========== */
    body.modo-simple {
      font-size: 18px;
    }
    
    body.modo-simple .btn {
      padding: 16px 24px;
      font-size: 18px;
      min-height: 56px;
    }
    
    body.modo-simple input,
    body.modo-simple select {
      padding: 16px;
      font-size: 18px;
      border: 2px solid var(--lav);
    }
    
    body.modo-simple .help-text {
      font-size: 16px;
    }

    /* ========== PRODUCTO ========== */
    .product{
      display:flex;
      gap:12px;
      align-items:center;
      border:1px dashed var(--line);
      padding:10px;
      border-radius:14px;
      background:#fbfbff;
    }
    
    .pimg{
      width:62px;
      height:62px;
      border-radius:14px;
      background:linear-gradient(160deg,#fff,#eef0ff);
      display:grid;
      place-items:center;
      font-size:26px;
      border:1px solid var(--line);
    }
    
    .price{font-weight:900;}
    
    .tag{
      font-size:11px;
      font-weight:800;
      padding:3px 7px;
      border-radius:9px;
      background:#e9fff2;
      color:#0a7d3b;
      border:1px solid #c9f0d8;
    }
    
    .tag.warn{
      background:#fff7e9;
      color:#915f00;
      border-color:#f2d8a8;
    }

    /* ========== TABLA ========== */
    table{width:100%;border-collapse:collapse;}
    th,td{padding:9px;border-bottom:1px solid var(--line);font-size:14px;}
    th{color:var(--muted);text-align:left;font-weight:800;}
    .right{text-align:right;}

    /* ========== FOOTER ========== */
    footer{
      color:var(--muted);
      font-size:12px;
      text-align:center;
      margin-top:14px;
    }
  </style>
</head>
<body>

<!-- Skip link para accesibilidad -->
<a href="#main-content" class="skip-link">Saltar al contenido principal</a>

<!-- Toast Container -->
<div class="toast-container" role="status" aria-live="polite" aria-atomic="true" id="toastContainer"></div>

<!-- Auto-save Indicator -->
<div class="auto-save saved" id="autoSaveIndicator" aria-live="polite" aria-atomic="true" style="display:none;">
  <span id="saveIcon">üíæ</span>
  <span id="saveText">Guardado autom√°ticamente</span>
</div>

<!-- Login Screen -->
<div id="loginScreen" style="
  position:fixed; inset:0; background:#f6f7ff;
  display:flex; align-items:center; justify-content:center;
  z-index:9999;" role="dialog" aria-labelledby="login-title" aria-modal="true">
  <div style="background:white; padding:24px; border-radius:16px; width:340px;
              box-shadow:0 10px 40px rgba(0,0,0,.1); border:1px solid #eceefe;">
    <h2 id="login-title" style="text-align:center; margin-top:0;">üêæ Bienvenido a Bonnie SIRA</h2>
    <p class="muted" style="text-align:center; margin-bottom:20px;">Sistema Inclusivo de Refugio Animal</p>

    <div class="form-group">
      <label for="roleSelect">Selecciona c√≥mo deseas ingresar
        <button class="help-btn" data-help="Elige 'Adoptante' si buscas una mascota, o 'Funcionario' si trabajas en el refugio" aria-label="Ayuda sobre roles">?</button>
      </label>
      <select id="roleSelect" aria-required="true">
        <option value="adoptante">Quiero adoptar una mascota üè†</option>
        <option value="admin">Soy funcionario del refugio üëî</option>
      </select>
      <small class="help-text">No te preocupes, puedes cambiar despu√©s</small>
    </div>

    <button onclick="login()" class="btn" style="width:100%;" aria-label="Ingresar al sistema">
      Ingresar al Sistema
    </button>
  </div>
</div>

<!-- Header -->
<header role="banner">
  <div class="brand">
    <div class="paw" aria-hidden="true">üêæ</div>
    <div>
      <div>Bonnie SIRA</div>
      <div class="muted" style="color:#eef;">Sistema Inclusivo de Refugio Animal</div>
    </div>
  </div>
  <nav role="navigation" aria-label="Navegaci√≥n principal">
    <button id="tab-home" class="active" onclick="show('home')" role="tab" aria-selected="true" aria-controls="home">
      <span aria-hidden="true">üè†</span> Inicio
    </button>
    <button id="tab-entradas" onclick="show('entradas')" role="tab" aria-selected="false" aria-controls="entradas">
      <span aria-hidden="true">üìù</span> Solicitar Adopci√≥n
    </button>
    <button id="tab-tienda" onclick="show('tienda')" role="tab" aria-selected="false" aria-controls="tienda">
      <span aria-hidden="true">üõçÔ∏è</span> Donar/Comprar
    </button>
    <button id="tab-carro" onclick="show('carro')" role="tab" aria-selected="false" aria-controls="carro">
      <span aria-hidden="true">üß∫</span> Mi Carrito 
      <span id="badge" class="chip" style="background:#fff;color:var(--lav);" aria-label="art√≠culos en el carrito">0</span>
    </button>
    <button id="tab-salidas" onclick="show('salidas')" role="tab" aria-selected="false" aria-controls="salidas">
      <span aria-hidden="true">üìÑ</span> Mis Documentos
    </button>
    <button id="tab-config" onclick="show('configuracion')" role="tab" aria-selected="false" aria-controls="configuracion">
      <span aria-hidden="true">‚öôÔ∏è</span> Configuraci√≥n
    </button>
    <button class="btn secondary" onclick="logout()" aria-label="Cerrar sesi√≥n">Salir</button>
  </nav>
</header>

<div class="wrap">
  <main id="main-content" role="main">

    <!-- HOME -->
    <section id="home" class="card" role="region" aria-labelledby="home-title">
      <h2 id="home-title">Bienvenido üè†</h2>
      <p class="muted">En Bonnie SIRA puedes adoptar mascotas, hacer donaciones y acceder a todos los documentos de forma f√°cil y accesible.</p>
      
      <div class="spacer"></div>
      
      <div class="grid">
        <article class="card" style="grid-column:span 4;">
          <h3>üêï Adopta con confianza</h3>
          <p class="muted">Completa un sencillo formulario, agenda tu visita y recibe el contrato digital.</p>
          <div class="row">
            <span class="chip">‚úÖ Proceso guiado</span>
            <span class="chip">üìÑ Documentos incluidos</span>
          </div>
          <div class="spacer"></div>
          <button class="btn" onclick="show('entradas')" aria-label="Ir a formulario de adopci√≥n">
            Comenzar Adopci√≥n
          </button>
        </article>
        
        <article class="card" style="grid-column:span 4;">
          <h3>‚ù§Ô∏è Apoya nuestra misi√≥n</h3>
          <p class="muted">Compra alimentos o dona directamente. Recibir√°s comprobante por correo.</p>
          <div class="row">
            <span class="chip">üí≥ Pago seguro</span>
            <span class="chip">üìß Boleta digital</span>
          </div>
          <div class="spacer"></div>
          <button class="btn ghost" onclick="show('tienda')" aria-label="Ir a tienda de donaciones">
            Ver Tienda
          </button>
        </article>
        
        <article class="card" style="grid-column:span 4;">
          <h3>üìã Accede a tus documentos</h3>
          <p class="muted">Revisa contratos, fichas cl√≠nicas y comprobantes en un solo lugar.</p>
          <div class="row">
            <span class="chip">üîí Seguro</span>
            <span class="chip">üì• Descargable</span>
          </div>
          <div class="spacer"></div>
          <button class="btn secondary" onclick="show('salidas')" aria-label="Ver mis documentos">
            Mis Documentos
          </button>
        </article>
      </div>
    </section>

    <!-- FORMULARIO DE ADOPCI√ìN (MEJORADO CON INCLUSI√ìN) -->
    <section id="entradas" class="hidden card" role="region" aria-labelledby="entradas-title">
      <nav class="breadcrumb" aria-label="Ruta de navegaci√≥n">
        <a href="#" onclick="show('home'); return false;">Inicio</a>
        <span aria-hidden="true">‚Ä∫</span>
        <span aria-current="page">Formulario de Adopci√≥n</span>
      </nav>

      <h2 id="entradas-title">Solicitud de Adopci√≥n</h2>
      <p class="muted">Completa este formulario para comenzar el proceso. Todos los campos marcados con <span class="required">*</span> son obligatorios.</p>
      
      <!-- Indicador de progreso -->
      <div class="progress-container" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Progreso del formulario">
        <div class="progress-bar" id="formProgress" style="width: 0%"></div>
      </div>
      <p class="progress-label" id="progressLabel">Paso 1 de 3</p>
      
      <div class="spacer"></div>

      <form id="adoptionForm" aria-label="Formulario de adopci√≥n">
        <div class="grid">
          <!-- PASO 1: Tus Datos -->
          <div class="card" style="grid-column:span 6;" id="step1">
            <h3>Paso 1: Tus datos personales</h3>
            
            <div class="form-group">
              <label for="inNombre">
                Nombre completo <span class="required" aria-label="obligatorio">*</span>
                <button type="button" class="help-btn" data-help="Escribe tu nombre tal como aparece en tu c√©dula de identidad" aria-label="Ayuda sobre nombre completo">?</button>
              </label>
              <input 
                type="text" 
                id="inNombre" 
                placeholder="Ejemplo: Mar√≠a Elena Gonz√°lez P√©rez" 
                required 
                aria-required="true"
                aria-describedby="help-nombre"
                onblur="validarCampo(this)" 
              />
              <small id="help-nombre" class="help-text">
                Ingresa tu nombre como aparece en tu documento de identidad
              </small>
              <span id="validation-nombre" class="validation-message" role="alert" aria-live="polite"></span>
            </div>

            <div class="form-group">
              <label for="inRut">
                RUT <span class="required">*</span>
                <button type="button" class="help-btn" data-help="Ingresa tu RUT sin puntos y con gui√≥n. Ejemplo: 12345678-9" aria-label="Ayuda sobre formato RUT">?</button>
              </label>
              <input 
                type="text" 
                id="inRut" 
                placeholder="12.345.678-9" 
                required 
                aria-required="true"
                aria-describedby="help-rut"
                oninput="formatearRUT(this)"
                onblur="validarRUT(this)"
              />
              <small id="help-rut" class="help-text">
                Formato: 12.345.678-9 (se formatea autom√°ticamente)
              </small>
              <span id="validation-rut" class="validation-message" role="alert" aria-live="polite"></span>
            </div>

            <div class="form-group">
              <label for="inCorreo">
                Correo electr√≥nico <span class="required">*</span>
                <button type="button" class="help-btn" data-help="Enviaremos la confirmaci√≥n de tu solicitud a este correo" aria-label="Ayuda sobre correo">?</button>
              </label>
              <input 
                type="email" 
                id="inCorreo" 
                placeholder="ejemplo@correo.cl" 
                required 
                aria-required="true"
                aria-describedby="help-correo"
                onblur="validarEmail(this)"
              />
              <small id="help-correo" class="help-text">
                Te enviaremos actualizaciones sobre tu adopci√≥n
              </small>
              <span id="validation-correo" class="validation-message" role="alert" aria-live="polite"></span>
            </div>

            <div class="form-group">
              <label for="inTelefono">
                Tel√©fono de contacto <span class="required">*</span>
              </label>
              <input 
                type="tel" 
                id="inTelefono" 
                placeholder="+56 9 8765 4321" 
                required 
                aria-required="true"
                aria-describedby="help-telefono"
                pattern="[0-9]{9}"
              />
              <small id="help-telefono" class="help-text">
                Formato: 987654321 (9 d√≠gitos, sin espacios)
              </small>
              <span id="validation-telefono" class="validation-message" role="alert" aria-live="polite"></span>
            </div>

            <button type="button" class="btn" onclick="siguientePaso(2)" aria-label="Continuar al paso 2">
              Siguiente: Datos de la Mascota ‚Üí
            </button>
          </div>

          <!-- PASO 2: Datos del Animal -->
          <div class="card" style="grid-column:span 6; display:none;" id="step2">
            <h3>Paso 2: ¬øQu√© mascota te interesa?</h3>
            
            <div class="form-group">
              <label for="inAnimalNombre">
                Nombre de la mascota
                <button type="button" class="help-btn" data-help="Si ya conoces el nombre de la mascota, ingr√©salo aqu√≠" aria-label="Ayuda sobre nombre de mascota">?</button>
              </label>
              <input 
                type="text" 
                id="inAnimalNombre" 
                placeholder="Ejemplo: Bonnie" 
                aria-describedby="help-animal"
              />
              <small id="help-animal" class="help-text">
                Opcional: Puedes dejarlo en blanco si a√∫n no decides
              </small>
            </div>

            <div class="form-group">
              <label for="inMicrochip">
                C√≥digo de identificaci√≥n (microchip)
                <button type="button" class="help-btn" data-help="El microchip es un c√≥digo √∫nico de la mascota. Si no lo sabes, d√©jalo en blanco" aria-label="Ayuda sobre microchip">?</button>
              </label>
              <input 
                type="text" 
                id="inMicrochip" 
                placeholder="Dejar en blanco si no lo conoces" 
                aria-describedby="help-microchip"
              />
              <small id="help-microchip" class="help-text">
                No te preocupes si no lo sabes, es opcional
              </small>
            </div>

            <div class="row" style="gap:12px;">
              <button type="button" class="btn secondary" onclick="siguientePaso(1)">
                ‚Üê Volver
              </button>
              <button type="button" class="btn" onclick="siguientePaso(3)" style="flex:1;">
                Siguiente: Agendar Visita ‚Üí
              </button>
            </div>
          </div>

          <!-- PASO 3: Proceso -->
          <div class="card" style="grid-column:span 6; display:none;" id="step3">
            <h3>Paso 3: Completa tu solicitud</h3>
            
            <div class="form-group">
              <label for="inTipoSolicitud">
                ¬øQu√© deseas hacer? <span class="required">*</span>
              </label>
              <select id="inTipoSolicitud" required aria-required="true">
                <option value="">Selecciona una opci√≥n</option>
                <option value="adopcion">Adoptar una mascota üè†</option>
                <option value="visita">Solo quiero visitarla üëÄ</option>
                <option value="hogar-temporal">Ser hogar temporal ‚è∞</option>
              </select>
            </div>

            <div class="form-group">
              <label for="inFecha">
                Fecha preferida para visitar <span class="required">*</span>
              </label>
              <input 
                type="date" 
                id="inFecha" 
                required 
                aria-required="true"
                min=""
              />
              <small class="help-text">
                Elige cu√°ndo te gustar√≠a conocer a tu futura mascota
              </small>
            </div>

            <div class="form-group">
              <label for="inObs">
                ¬øAlgo m√°s que quieras contarnos?
              </label>
              <textarea 
                id="inObs" 
                rows="4" 
                placeholder="Ejemplo: Tengo experiencia con perros grandes, vivo en casa con patio..."
                aria-describedby="help-obs"
              ></textarea>
              <small id="help-obs" class="help-text">
                Opcional: Cu√©ntanos sobre tu hogar o experiencia previa
              </small>
            </div>

            <div class="row" style="gap:12px;">
              <button type="button" class="btn secondary" onclick="siguientePaso(2)">
                ‚Üê Volver
              </button>
              <button type="submit" class="btn" onclick="guardarSolicitud(event)" style="flex:1;">
                ‚úì Enviar Solicitud
              </button>
            </div>
          </div>

          <!-- Resumen y confirmaci√≥n -->
          <div class="card" style="grid-column:span 6;">
            <h3>üìã Vista previa</h3>
            <div id="entradaPreview" class="muted">
              Completa el formulario para ver un resumen de tu solicitud aqu√≠.
            </div>
            
            <div class="spacer"></div>
            
            <h3>√öltimas solicitudes</h3>
            <div style="overflow-x:auto;">
              <table role="table" aria-label="Historial de solicitudes">
                <caption class="sr-only">Historial de las √∫ltimas 5 solicitudes de adopci√≥n</caption>
                <thead>
                  <tr>
                    <th scope="col">Fecha</th>
                    <th scope="col">Adoptante</th>
                    <th scope="col">Mascota</th>
                    <th scope="col">Tipo</th>
                  </tr>
                </thead>
                <tbody id="tablaEntradas">
                  <tr>
                    <td colspan="4" class="muted" style="text-align:center;">
                      No hay registros a√∫n
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </form>
    </section>

    <!-- CONFIGURACI√ìN DE ACCESIBILIDAD -->
    <section id="configuracion" class="hidden card" role="region" aria-labelledby="config-title">
      <h2 id="config-title">‚öôÔ∏è Configuraci√≥n de Accesibilidad</h2>
      <p class="muted">Personaliza la interfaz seg√∫n tus necesidades.</p>
      
      <div class="spacer"></div>
      
      <div class="grid">
        <div class="card" style="grid-column:span 6;">
          <h3>üé® Apariencia</h3>
          
          <div class="form-group">
            <label>Tama√±o de texto</label>
            <input 
              type="range" 
              min="14" 
              max="22" 
              value="16" 
              id="rangeTexto"
              oninput="cambiarTamanoTexto(this.value)"
              aria-label="Ajustar tama√±o de texto"
              aria-valuemin="14"
              aria-valuemax="22"
              aria-valuenow="16"
            />
            <output id="outputTexto" for="rangeTexto" aria-live="polite">16px</output>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="checkModoSimple" onchange="toggleModoSimple(this.checked)" />
              Activar modo simplificado (textos m√°s grandes, menos opciones)
            </label>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="checkAnimaciones" checked onchange="toggleAnimaciones(this.checked)" />
              Permitir animaciones
            </label>
            <small class="help-text">Desactiva si las animaciones te molestan</small>
          </div>
        </div>

        <div class="card" style="grid-column:span 6;">
          <h3>üîî Notificaciones</h3>
          
          <div class="form-group">
            <label>
              <input type="checkbox" id="checkSonidos" onchange="toggleSonidos(this.checked)" />
              Activar notificaciones sonoras
            </label>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="checkAutoGuardar" checked onchange="toggleAutoGuardar(this.checked)" />
              Guardar autom√°ticamente mi progreso
            </label>
            <small class="help-text">Recomendado para no perder tu informaci√≥n</small>
          </div>

          <div class="spacer"></div>

          <button class="btn" onclick="guardarConfiguracion()">
            üíæ Guardar Configuraci√≥n
          </button>
        </div>
      </div>
    </section>

    <!-- Otras secciones (tienda, carro, salidas) se mantienen igual pero con mejoras de accesibilidad -->

    <!-- TIENDA / DONACIONES -->
    <section id="tienda" class="hidden card" role="region" aria-labelledby="tienda-title">
      <nav class="breadcrumb" aria-label="Ruta de navegaci√≥n">
        <a href="#" onclick="show('home'); return false;">Inicio</a>
        <span aria-hidden="true">‚Ä∫</span>
        <span aria-current="page">Tienda y Donaciones</span>
      </nav>

      <h2 id="tienda-title">üõçÔ∏è Tienda y Donaciones</h2>
      <p class="muted">Apoya nuestra causa comprando productos o realizando una donaci√≥n directa.</p>
      
      <div class="spacer"></div>

      <div class="grid">
        <!-- Productos -->
        <div class="card" style="grid-column:span 8;">
          <h3>Productos Disponibles</h3>
          <div class="spacer"></div>
          
          <div id="productosLista" class="grid" style="gap:16px;">
            <!-- Producto 1 -->
            <article class="product">
              <div class="pimg" aria-hidden="true">üçñ</div>
              <div style="flex:1;">
                <strong>Alimento para Perros Premium</strong>
                <div class="muted" style="font-size:12px;">Saco 15kg - Todas las edades</div>
                <div style="margin-top:8px;">
                  <span class="price">$25.990</span>
                  <span class="tag">En stock</span>
                </div>
              </div>
              <button 
                class="btn" 
                onclick="agregarAlCarrito('Alimento Perros Premium', 25990, 'üçñ')"
                aria-label="Agregar alimento para perros al carrito"
              >
                + Agregar
              </button>
            </article>

            <!-- Producto 2 -->
            <article class="product">
              <div class="pimg" aria-hidden="true">üêü</div>
              <div style="flex:1;">
                <strong>Alimento para Gatos</strong>
                <div class="muted" style="font-size:12px;">Saco 7.5kg - Adultos</div>
                <div style="margin-top:8px;">
                  <span class="price">$19.990</span>
                  <span class="tag">En stock</span>
                </div>
              </div>
              <button 
                class="btn" 
                onclick="agregarAlCarrito('Alimento Gatos', 19990, 'üêü')"
                aria-label="Agregar alimento para gatos al carrito"
              >
                + Agregar
              </button>
            </article>

            <!-- Producto 3 -->
            <article class="product">
              <div class="pimg" aria-hidden="true">ü¶¥</div>
              <div style="flex:1;">
                <strong>Snacks y Premios</strong>
                <div class="muted" style="font-size:12px;">Variedad de sabores</div>
                <div style="margin-top:8px;">
                  <span class="price">$5.990</span>
                  <span class="tag">En stock</span>
                </div>
              </div>
              <button 
                class="btn" 
                onclick="agregarAlCarrito('Snacks Variados', 5990, 'ü¶¥')"
                aria-label="Agregar snacks al carrito"
              >
                + Agregar
              </button>
            </article>

            <!-- Producto 4 -->
            <article class="product">
              <div class="pimg" aria-hidden="true">üß∏</div>
              <div style="flex-1;">
                <strong>Juguetes para Mascotas</strong>
                <div class="muted" style="font-size:12px;">Pack de 3 unidades</div>
                <div style="margin-top:8px;">
                  <span class="price">$8.990</span>
                  <span class="tag warn">Pocas unidades</span>
                </div>
              </div>
              <button 
                class="btn" 
                onclick="agregarAlCarrito('Pack Juguetes', 8990, 'üß∏')"
                aria-label="Agregar juguetes al carrito"
              >
                + Agregar
              </button>
            </article>

            <!-- Producto 5 -->
            <article class="product">
              <div class="pimg" aria-hidden="true">üõèÔ∏è</div>
              <div style="flex:1;">
                <strong>Cama para Mascotas</strong>
                <div class="muted" style="font-size:12px;">Tama√±o M - Lavable</div>
                <div style="margin-top:8px;">
                  <span class="price">$34.990</span>
                  <span class="tag">En stock</span>
                </div>
              </div>
              <button 
                class="btn" 
                onclick="agregarAlCarrito('Cama Mascotas M', 34990, 'üõèÔ∏è')"
                aria-label="Agregar cama al carrito"
              >
                + Agregar
              </button>
            </article>

            <!-- Producto 6 -->
            <article class="product">
              <div class="pimg" aria-hidden="true">üß¥</div>
              <div style="flex:1;">
                <strong>Shampoo Antipulgas</strong>
                <div class="muted" style="font-size:12px;">500ml - Hipoalerg√©nico</div>
                <div style="margin-top:8px;">
                  <span class="price">$12.990</span>
                  <span class="tag">En stock</span>
                </div>
              </div>
              <button 
                class="btn" 
                onclick="agregarAlCarrito('Shampoo Antipulgas', 12990, 'üß¥')"
                aria-label="Agregar shampoo al carrito"
              >
                + Agregar
              </button>
            </article>
          </div>
        </div>

        <!-- Donaci√≥n Directa -->
        <div class="card" style="grid-column:span 4;">
          <h3>üíù Donaci√≥n Directa</h3>
          <p class="muted">Tu aporte nos ayuda a cuidar mejor a nuestras mascotas.</p>
          
          <div class="spacer"></div>

          <div class="form-group">
            <label for="montoPersonalizado">Monto a donar</label>
            <div style="display:flex; gap:8px; margin-bottom:12px;">
              <button type="button" class="chip" onclick="seleccionarMontoDonacion(5000)" style="cursor:pointer;">
                $5.000
              </button>
              <button type="button" class="chip" onclick="seleccionarMontoDonacion(10000)" style="cursor:pointer;">
                $10.000
              </button>
              <button type="button" class="chip" onclick="seleccionarMontoDonacion(20000)" style="cursor:pointer;">
                $20.000
              </button>
            </div>
            <input 
              type="number" 
              id="montoPersonalizado" 
              placeholder="O ingresa un monto personalizado"
              min="1000"
              step="1000"
              aria-label="Monto personalizado de donaci√≥n"
            />
            <small class="help-text">Monto m√≠nimo: $1.000</small>
          </div>

          <div class="form-group">
            <label for="nombreDonante">Tu nombre (opcional)</label>
            <input 
              type="text" 
              id="nombreDonante" 
              placeholder="An√≥nimo"
              aria-label="Nombre del donante"
            />
          </div>

          <div class="form-group">
            <label for="mensajeDonacion">Mensaje de apoyo (opcional)</label>
            <textarea 
              id="mensajeDonacion" 
              rows="3"
              placeholder="Escribe un mensaje de apoyo para nuestro equipo..."
              aria-label="Mensaje de apoyo"
            ></textarea>
          </div>

          <button class="btn" onclick="procesarDonacion()" style="width:100%;">
            ‚ù§Ô∏è Realizar Donaci√≥n
          </button>

          <div class="spacer"></div>
          
          <div style="background:#fff7e9; padding:12px; border-radius:12px; border:1px solid #f2d8a8;">
            <small style="color:#915f00;">
              <strong>‚ÑπÔ∏è Nota:</strong> Recibir√°s un comprobante de donaci√≥n por correo electr√≥nico.
            </small>
          </div>
        </div>
      </div>
    </section>

    <!-- CARRITO -->
    <section id="carro" class="hidden card" role="region" aria-labelledby="carro-title">
      <nav class="breadcrumb" aria-label="Ruta de navegaci√≥n">
        <a href="#" onclick="show('home'); return false;">Inicio</a>
        <span aria-hidden="true">‚Ä∫</span>
        <span aria-current="page">Mi Carrito</span>
      </nav>

      <h2 id="carro-title">üß∫ Mi Carrito de Compras</h2>
      <p class="muted">Revisa y confirma tu compra antes de proceder al pago.</p>
      
      <div class="spacer"></div>

      <div class="grid">
        <!-- Lista del carrito -->
        <div class="card" style="grid-column:span 8;">
          <h3>Productos en tu carrito</h3>
          
          <div class="spacer"></div>
          
          <div id="carritoLista">
            <div class="muted" style="text-align:center; padding:40px;">
              üõí Tu carrito est√° vac√≠o
            </div>
          </div>
        </div>

        <!-- Resumen de compra -->
        <div class="card" style="grid-column:span 4;">
          <h3>Resumen de Compra</h3>
          
          <div class="spacer"></div>
          
          <table role="presentation">
            <tr>
              <td>Subtotal:</td>
              <td class="right"><strong id="subtotalCarrito">$0</strong></td>
            </tr>
            <tr>
              <td>Descuento:</td>
              <td class="right" style="color:var(--success);" id="descuentoCarrito">-$0</td>
            </tr>
            <tr>
              <td>Env√≠o:</td>
              <td class="right" id="envioCarrito">Gratis</td>
            </tr>
            <tr style="border-top:2px solid var(--lav);">
              <td><strong>TOTAL:</strong></td>
              <td class="right"><strong style="font-size:20px; color:var(--lav);" id="totalCarrito">$0</strong></td>
            </tr>
          </table>

          <div class="spacer"></div>

          <div class="form-group">
            <label for="codigoDescuento">C√≥digo de descuento</label>
            <div style="display:flex; gap:8px;">
              <input 
                type="text" 
                id="codigoDescuento" 
                placeholder="REFUGIO2025"
                aria-label="C√≥digo de descuento"
                style="flex:1;"
              />
              <button class="btn secondary" onclick="aplicarDescuento()">
                Aplicar
              </button>
            </div>
            <small class="help-text">C√≥digo: REFUGIO2025 = 10% descuento</small>
          </div>

          <div class="spacer"></div>

          <button 
            class="btn" 
            id="btnProcederPago"
            onclick="procederPago()" 
            style="width:100%;"
            disabled
          >
            üí≥ Proceder al Pago
          </button>

          <div class="spacer"></div>

          <button class="btn ghost" onclick="vaciarCarrito()" style="width:100%;">
            üóëÔ∏è Vaciar Carrito
          </button>
        </div>
      </div>
    </section>

    <!-- MIS DOCUMENTOS / SALIDAS -->
    <section id="salidas" class="hidden card" role="region" aria-labelledby="salidas-title">
      <nav class="breadcrumb" aria-label="Ruta de navegaci√≥n">
        <a href="#" onclick="show('home'); return false;">Inicio</a>
        <span aria-hidden="true">‚Ä∫</span>
        <span aria-current="page">Mis Documentos</span>
      </nav>

      <h2 id="salidas-title">üìÑ Mis Documentos</h2>
      <p class="muted">Accede y descarga todos tus comprobantes, contratos y boletas.</p>
      
      <div class="spacer"></div>

      <div class="grid">
        <div class="card" style="grid-column:span 12;">
          <h3>Documentos Disponibles</h3>
          
          <div class="spacer"></div>
          
          <div id="documentosLista">
            <table role="table" aria-label="Lista de documentos">
              <thead>
                <tr>
                  <th scope="col">Tipo</th>
                  <th scope="col">Descripci√≥n</th>
                  <th scope="col">Fecha</th>
                  <th scope="col" class="right">Acciones</th>
                </tr>
              </thead>
              <tbody id="tablaDocumentos">
                <tr>
                  <td colspan="4" class="muted" style="text-align:center;">
                    No tienes documentos generados a√∫n
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="spacer"></div>

          <div style="background:#e9fff2; padding:16px; border-radius:12px; border:1px solid #c9f0d8;">
            <h4 style="margin-top:0; color:#0a7d3b;">üí° ¬øC√≥mo genero documentos?</h4>
            <ul style="margin:0; padding-left:20px; color:#0a7d3b;">
              <li>Completa una solicitud de adopci√≥n para obtener tu comprobante</li>
              <li>Realiza una compra en la tienda para recibir tu boleta</li>
              <li>Todos los documentos se guardan autom√°ticamente aqu√≠</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- Modal accesible -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-hidden="true">
  <div class="dialog">
    <header>
      <h3 id="modalTitle">T√≠tulo del Modal</h3>
      <button class="x" onclick="closeModal()" aria-label="Cerrar di√°logo">√ó</button>
    </header>
    <div id="modalBody" role="document"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  // ========== GESTI√ìN DE ESTADO Y DATOS ==========
  let currentRole = '';
  const entradas = [];
  let currentStep = 1;
  let autoGuardarActivo = true;
  let configuracion = {
    tamanoTexto: 16,
    modoSimple: false,
    animaciones: true,
    sonidos: false,
    autoGuardar: true
  };


  // ========== CARRITO DE COMPRAS ==========
  let carrito = [];
  let descuentoAplicado = false;
  let porcentajeDescuento = 0;

  function agregarAlCarrito(nombre, precio, icono) {
    // Verificar si el producto ya existe
    const existe = carrito.find(item => item.nombre === nombre);
    
    if (existe) {
      existe.cantidad++;
    } else {
      carrito.push({
        id: Date.now(),
        nombre: nombre,
        precio: precio,
        icono: icono,
        cantidad: 1
      });
    }
    
    actualizarCarrito();
    mostrarToast('Producto agregado', `${nombre} agregado al carrito`, 'success');
    
    // Guardar en localStorage
    localStorage.setItem('carrito_bonnie', JSON.stringify(carrito));
  }

  function eliminarDelCarrito(id) {
    carrito = carrito.filter(item => item.id !== id);
    actualizarCarrito();
    mostrarToast('Producto eliminado', 'Se elimin√≥ el producto del carrito', 'info');
    localStorage.setItem('carrito_bonnie', JSON.stringify(carrito));
  }

  function cambiarCantidad(id, delta) {
    const item = carrito.find(i => i.id === id);
    if (item) {
      item.cantidad += delta;
      if (item.cantidad <= 0) {
        eliminarDelCarrito(id);
      } else {
        actualizarCarrito();
        localStorage.setItem('carrito_bonnie', JSON.stringify(carrito));
      }
    }
  }

  function actualizarCarrito() {
    const badge = document.getElementById('badge');
    const carritoLista = document.getElementById('carritoLista');
    const btnPagar = document.getElementById('btnProcederPago');
    
    // Actualizar badge
    const totalItems = carrito.reduce((sum, item) => sum + item.cantidad, 0);
    badge.textContent = totalItems;
    badge.style.display = totalItems > 0 ? 'inline-block' : 'none';
    
    // Actualizar lista del carrito
    if (carrito.length === 0) {
      carritoLista.innerHTML = `
        <div class="muted" style="text-align:center; padding:40px;">
          üõí Tu carrito est√° vac√≠o<br>
          <div class="spacer"></div>
          <button class="btn ghost" onclick="show('tienda')">
            Ir a la Tienda
          </button>
        </div>
      `;
      btnPagar.disabled = true;
    } else {
      carritoLista.innerHTML = carrito.map(item => `
        <div class="product" style="margin-bottom:12px;">
          <div class="pimg" aria-hidden="true">${item.icono}</div>
          <div style="flex:1;">
            <strong>${item.nombre}</strong>
            <div class="muted" style="font-size:12px;">Precio unitario: $${item.precio.toLocaleString('es-CL')}</div>
            <div style="margin-top:8px;">
              <span class="price">$${(item.precio * item.cantidad).toLocaleString('es-CL')}</span>
            </div>
          </div>
          <div style="display:flex; align-items:center; gap:8px;">
            <button 
              class="btn secondary" 
              onclick="cambiarCantidad(${item.id}, -1)"
              aria-label="Reducir cantidad"
              style="width:36px; padding:6px;"
            >
              ‚àí
            </button>
            <span style="min-width:24px; text-align:center; font-weight:bold;">${item.cantidad}</span>
            <button 
              class="btn secondary" 
              onclick="cambiarCantidad(${item.id}, 1)"
              aria-label="Aumentar cantidad"
              style="width:36px; padding:6px;"
            >
              +
            </button>
          </div>
          <button 
            class="btn ghost" 
            onclick="eliminarDelCarrito(${item.id})"
            aria-label="Eliminar producto"
          >
            üóëÔ∏è
          </button>
        </div>
      `).join('');
      btnPagar.disabled = false;
    }
    
    // Calcular totales
    calcularTotales();
  }

  function calcularTotales() {
    const subtotal = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
    const descuento = descuentoAplicado ? Math.round(subtotal * porcentajeDescuento) : 0;
    const total = subtotal - descuento;
    
    document.getElementById('subtotalCarrito').textContent = `$${subtotal.toLocaleString('es-CL')}`;
    document.getElementById('descuentoCarrito').textContent = descuento > 0 ? `-$${descuento.toLocaleString('es-CL')}` : '-$0';
    document.getElementById('totalCarrito').textContent = `$${total.toLocaleString('es-CL')}`;
  }

  function aplicarDescuento() {
    const codigo = document.getElementById('codigoDescuento').value.trim().toUpperCase();
    
    if (codigo === 'REFUGIO2025') {
      descuentoAplicado = true;
      porcentajeDescuento = 0.10; // 10%
      calcularTotales();
      mostrarToast('¬°Descuento aplicado!', '10% de descuento agregado a tu compra', 'success');
      document.getElementById('codigoDescuento').disabled = true;
    } else if (codigo === '') {
      mostrarToast('Campo vac√≠o', 'Por favor ingresa un c√≥digo de descuento', 'warning');
    } else {
      mostrarToast('C√≥digo inv√°lido', 'El c√≥digo ingresado no es v√°lido', 'error');
    }
  }

  function vaciarCarrito() {
    if (carrito.length === 0) {
      mostrarToast('Carrito vac√≠o', 'No hay productos para eliminar', 'info');
      return;
    }
    
    if (confirm('¬øEst√°s seguro de que deseas vaciar el carrito?')) {
      carrito = [];
      descuentoAplicado = false;
      porcentajeDescuento = 0;
      document.getElementById('codigoDescuento').disabled = false;
      document.getElementById('codigoDescuento').value = '';
      actualizarCarrito();
      mostrarToast('Carrito vaciado', 'Todos los productos fueron eliminados', 'success');
      localStorage.removeItem('carrito_bonnie');
    }
  }

  function procederPago() {
    if (carrito.length === 0) {
      mostrarToast('Carrito vac√≠o', 'Agrega productos antes de pagar', 'warning');
      return;
    }
    
    const subtotal = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
    const descuento = descuentoAplicado ? Math.round(subtotal * porcentajeDescuento) : 0;
    const total = subtotal - descuento;
    
    // Simular pago
    mostrarToast('Procesando pago...', 'Redirigiendo a Webpay...', 'info');
    
    setTimeout(() => {
      // Simular pago exitoso
      generarBoletaCompra(carrito, subtotal, descuento, total);
      
      // Vaciar carrito
      carrito = [];
      descuentoAplicado = false;
      porcentajeDescuento = 0;
      actualizarCarrito();
      localStorage.removeItem('carrito_bonnie');
      
      mostrarToast('¬°Pago exitoso!', 'Tu compra ha sido procesada correctamente', 'success');
      
      // Ir a documentos
      setTimeout(() => {
        show('salidas');
      }, 2000);
    }, 2500);
  }

  // ========== DONACIONES ==========
  function seleccionarMontoDonacion(monto) {
    document.getElementById('montoPersonalizado').value = monto;
  }

  function procesarDonacion() {
    const monto = parseInt(document.getElementById('montoPersonalizado').value) || 0;
    const nombre = document.getElementById('nombreDonante').value.trim() || 'An√≥nimo';
    const mensaje = document.getElementById('mensajeDonacion').value.trim();
    
    if (monto < 1000) {
      mostrarToast('Monto inv√°lido', 'El monto m√≠nimo de donaci√≥n es $1.000', 'error');
      return;
    }
    
    mostrarToast('Procesando donaci√≥n...', 'Redirigiendo a Webpay...', 'info');
    
    setTimeout(() => {
      generarComprobanteDonacion(nombre, monto, mensaje);
      
      // Limpiar formulario
      document.getElementById('montoPersonalizado').value = '';
      document.getElementById('nombreDonante').value = '';
      document.getElementById('mensajeDonacion').value = '';
      
      mostrarToast('¬°Gracias por tu donaci√≥n!', `${nombre}, tu aporte de $${monto.toLocaleString('es-CL')} ha sido procesado`, 'success');
      
      setTimeout(() => {
        show('salidas');
      }, 2000);
    }, 2500);
  }

  // ========== GENERACI√ìN DE DOCUMENTOS ==========
  let documentos = [];

  function generarBoletaCompra(items, subtotal, descuento, total) {
    const doc = {
      id: Date.now(),
      tipo: 'Boleta de Compra',
      descripcion: `Compra de ${items.length} producto(s)`,
      fecha: new Date().toLocaleDateString('es-CL'),
      datos: { items, subtotal, descuento, total }
    };
    
    documentos.push(doc);
    actualizarListaDocumentos();
    localStorage.setItem('documentos_bonnie', JSON.stringify(documentos));
    
    // Generar PDF
    generarPDFBoleta(doc);
  }

  function generarComprobanteDonacion(nombre, monto, mensaje) {
    const doc = {
      id: Date.now(),
      tipo: 'Comprobante de Donaci√≥n',
      descripcion: `Donaci√≥n de $${monto.toLocaleString('es-CL')}`,
      fecha: new Date().toLocaleDateString('es-CL'),
      datos: { nombre, monto, mensaje }
    };
    
    documentos.push(doc);
    actualizarListaDocumentos();
    localStorage.setItem('documentos_bonnie', JSON.stringify(documentos));
    
    // Generar PDF
    generarPDFDonacion(doc);
  }

  function agregarDocumentoAdopcion(datos) {
    const doc = {
      id: Date.now(),
      tipo: 'Solicitud de Adopci√≥n',
      descripcion: `Solicitud para ${datos.mascota}`,
      fecha: new Date().toLocaleDateString('es-CL'),
      datos: datos
    };
    
    documentos.push(doc);
    actualizarListaDocumentos();
    localStorage.setItem('documentos_bonnie', JSON.stringify(documentos));
  }

  function actualizarListaDocumentos() {
    const tabla = document.getElementById('tablaDocumentos');
    
    if (documentos.length === 0) {
      tabla.innerHTML = `
        <tr>
          <td colspan="4" class="muted" style="text-align:center;">
            No tienes documentos generados a√∫n
          </td>
        </tr>
      `;
    } else {
      tabla.innerHTML = documentos.map(doc => `
        <tr>
          <td>
            <span class="chip" style="background:#e9fff2; color:#0a7d3b; border-color:#c9f0d8;">
              ${doc.tipo}
            </span>
          </td>
          <td>${doc.descripcion}</td>
          <td>${doc.fecha}</td>
          <td class="right">
            <button 
              class="btn secondary" 
              onclick="regenerarPDF(${doc.id})"
              aria-label="Descargar documento"
              style="font-size:12px; padding:6px 12px;"
            >
              üì• Descargar PDF
            </button>
          </td>
        </tr>
      `).join('');
    }
  }

  function regenerarPDF(id) {
    const doc = documentos.find(d => d.id === id);
    if (!doc) return;
    
    if (doc.tipo === 'Boleta de Compra') {
      generarPDFBoleta(doc);
    } else if (doc.tipo === 'Comprobante de Donaci√≥n') {
      generarPDFDonacion(doc);
    } else if (doc.tipo === 'Solicitud de Adopci√≥n') {
      generarPDFAdopcion(doc);
    }
  }

  function generarPDFBoleta(doc) {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    
    // Encabezado
    pdf.setFontSize(20);
    pdf.setTextColor(122, 119, 255);
    pdf.text('Bonnie SIRA', 20, 20);
    
    pdf.setFontSize(12);
    pdf.setTextColor(0, 0, 0);
    pdf.text('Sistema Inclusivo de Refugio Animal', 20, 28);
    
    // L√≠nea
    pdf.setDrawColor(127, 211, 255);
    pdf.setLineWidth(0.5);
    pdf.line(20, 32, 190, 32);
    
    // T√≠tulo
    pdf.setFontSize(16);
    pdf.text('BOLETA DE COMPRA', 20, 45);
    
    // Fecha
    pdf.setFontSize(11);
    pdf.text(`Fecha: ${doc.fecha}`, 20, 55);
    pdf.text(`N¬∞ Documento: ${doc.id}`, 20, 62);
    
    // Productos
    pdf.setFontSize(14);
    pdf.text('Productos:', 20, 75);
    
    let y = 85;
    pdf.setFontSize(10);
    doc.datos.items.forEach(item => {
      pdf.text(`${item.icono} ${item.nombre}`, 25, y);
      pdf.text(`${item.cantidad} x $${item.precio.toLocaleString('es-CL')}`, 120, y);
      pdf.text(`$${(item.precio * item.cantidad).toLocaleString('es-CL')}`, 160, y, { align: 'right' });
      y += 7;
    });
    
    // Totales
    y += 10;
    pdf.line(20, y, 190, y);
    y += 8;
    
    pdf.text('Subtotal:', 120, y);
    pdf.text(`$${doc.datos.subtotal.toLocaleString('es-CL')}`, 180, y, { align: 'right' });
    y += 7;
    
    if (doc.datos.descuento > 0) {
      pdf.setTextColor(10, 125, 59);
      pdf.text('Descuento:', 120, y);
      pdf.text(`-$${doc.datos.descuento.toLocaleString('es-CL')}`, 180, y, { align: 'right' });
      y += 7;
      pdf.setTextColor(0, 0, 0);
    }
    
    pdf.setFontSize(12);
    pdf.setFont(undefined, 'bold');
    pdf.text('TOTAL:', 120, y);
    pdf.text(`$${doc.datos.total.toLocaleString('es-CL')}`, 180, y, { align: 'right' });
    
    // Pie
    pdf.setFontSize(9);
    pdf.setFont(undefined, 'normal');
    pdf.setTextColor(100, 100, 100);
    pdf.text('Gracias por apoyar nuestra causa', 105, 270, { align: 'center' });
    pdf.text('Todos los fondos se destinan al cuidado de nuestras mascotas', 105, 275, { align: 'center' });
    
    pdf.save(`Boleta_${doc.id}.pdf`);
    mostrarToast('PDF descargado', 'La boleta se descarg√≥ correctamente', 'success');
  }

  function generarPDFDonacion(doc) {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    
    // Encabezado
    pdf.setFontSize(20);
    pdf.setTextColor(122, 119, 255);
    pdf.text('Bonnie SIRA', 20, 20);
    
    pdf.setFontSize(12);
    pdf.setTextColor(0, 0, 0);
    pdf.text('Sistema Inclusivo de Refugio Animal', 20, 28);
    
    // L√≠nea
    pdf.setDrawColor(127, 211, 255);
    pdf.setLineWidth(0.5);
    pdf.line(20, 32, 190, 32);
    
    // T√≠tulo
    pdf.setFontSize(16);
    pdf.text('COMPROBANTE DE DONACI√ìN', 20, 45);
    
    // Datos
    pdf.setFontSize(11);
    pdf.text(`Fecha: ${doc.fecha}`, 20, 60);
    pdf.text(`N¬∞ Comprobante: ${doc.id}`, 20, 67);
    
    pdf.setFontSize(14);
    pdf.text('Datos del Donante:', 20, 82);
    pdf.setFontSize(11);
    pdf.text(`Nombre: ${doc.datos.nombre}`, 25, 92);
    
    pdf.setFontSize(14);
    pdf.text('Monto Donado:', 20, 110);
    pdf.setFontSize(18);
    pdf.setTextColor(10, 125, 59);
    pdf.text(`$${doc.datos.monto.toLocaleString('es-CL')}`, 25, 122);
    
    pdf.setTextColor(0, 0, 0);
    
    if (doc.datos.mensaje) {
      pdf.setFontSize(12);
      pdf.text('Mensaje:', 20, 140);
      pdf.setFontSize(10);
      const lines = pdf.splitTextToSize(doc.datos.mensaje, 170);
      pdf.text(lines, 25, 150);
    }
    
    // Agradecimiento
    pdf.setFontSize(14);
    pdf.setTextColor(122, 119, 255);
    pdf.text('¬°Muchas gracias por tu generosidad!', 105, 200, { align: 'center' });
    
    pdf.setFontSize(10);
    pdf.setTextColor(0, 0, 0);
    pdf.text('Tu aporte nos ayuda a seguir salvando vidas', 105, 210, { align: 'center' });
    
    // Pie
    pdf.setFontSize(9);
    pdf.setTextColor(100, 100, 100);
    pdf.text('Este comprobante es v√°lido para efectos tributarios', 105, 270, { align: 'center' });
    
    pdf.save(`Donacion_${doc.id}.pdf`);
    mostrarToast('PDF descargado', 'El comprobante se descarg√≥ correctamente', 'success');
  }

  function generarPDFAdopcion(doc) {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    
    // Encabezado
    pdf.setFontSize(20);
    pdf.setTextColor(122, 119, 255);
    pdf.text('Bonnie SIRA', 20, 20);
    
    pdf.setFontSize(12);
    pdf.setTextColor(0, 0, 0);
    pdf.text('Sistema Inclusivo de Refugio Animal', 20, 28);
    
    // L√≠nea
    pdf.setDrawColor(127, 211, 255);
    pdf.setLineWidth(0.5);
    pdf.line(20, 32, 190, 32);
    
    // T√≠tulo
    pdf.setFontSize(16);
    pdf.text('SOLICITUD DE ADOPCI√ìN', 20, 45);
    
    // Datos
    pdf.setFontSize(11);
    pdf.text(`Fecha: ${doc.fecha}`, 20, 60);
    pdf.text(`N¬∞ Solicitud: ${doc.id}`, 20, 67);
    
    pdf.setFontSize(14);
    pdf.text('Datos del Solicitante:', 20, 82);
    pdf.setFontSize(10);
    pdf.text(`Nombre: ${doc.datos.nombre}`, 25, 92);
    pdf.text(`RUT: ${doc.datos.rut}`, 25, 99);
    pdf.text(`Email: ${doc.datos.email}`, 25, 106);
    pdf.text(`Tel√©fono: ${doc.datos.telefono}`, 25, 113);
    
    pdf.setFontSize(14);
    pdf.text('Mascota Solicitada:', 20, 128);
    pdf.setFontSize(10);
    pdf.text(`${doc.datos.mascota}`, 25, 138);
    
    // Pie
    pdf.setFontSize(9);
    pdf.setTextColor(100, 100, 100);
    pdf.text('Nos contactaremos contigo en las pr√≥ximas 48 horas', 105, 270, { align: 'center' });
    
    pdf.save(`Adopcion_${doc.id}.pdf`);
    mostrarToast('PDF descargado', 'La solicitud se descarg√≥ correctamente', 'success');
  }

  // ========== CARGAR DATOS AL INICIAR ==========
  function cargarDatosGuardados() {
    // Cargar carrito
    const carritoGuardado = localStorage.getItem('carrito_bonnie');
    if (carritoGuardado) {
      carrito = JSON.parse(carritoGuardado);
      actualizarCarrito();
    }
    
    // Cargar documentos
    const documentosGuardados = localStorage.getItem('documentos_bonnie');
    if (documentosGuardados) {
      documentos = JSON.parse(documentosGuardados);
      actualizarListaDocumentos();
    }
  }

  // Llamar al cargar la p√°gina
  window.addEventListener('DOMContentLoaded', cargarDatosGuardados);

  // ========== FUNCIONES DE LOGIN ==========
  function login(){
    currentRole = document.getElementById('roleSelect').value;
    document.getElementById('loginScreen').style.display = 'none';
    mostrarToast('¬°Bienvenido!', `Has ingresado como ${currentRole === 'adoptante' ? 'adoptante' : 'funcionario del refugio'}`, 'success');
    cargarConfiguracion();
  }

  function logout(){
    if(confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')){
      document.getElementById('loginScreen').style.display = 'flex';
      show('home');
      mostrarToast('Sesi√≥n cerrada', 'Vuelve pronto üëã', 'success');
    }
  }

  // ========== NAVEGACI√ìN ==========
  function show(sec){
    // Ocultar todas las secciones
    document.querySelectorAll('section').forEach(s => {
      s.classList.add('hidden');
      s.setAttribute('aria-hidden', 'true');
    });
    
    // Mostrar secci√≥n seleccionada
    const section = document.getElementById(sec);
    section.classList.remove('hidden');
    section.setAttribute('aria-hidden', 'false');
    section.focus();

    // Actualizar tabs
    document.querySelectorAll('nav button[role="tab"]').forEach(btn => {
      btn.classList.remove('active');
      btn.setAttribute('aria-selected', 'false');
    });
    
    const activeTab = document.getElementById(`tab-${sec}`);
    if(activeTab){
      activeTab.classList.add('active');
      activeTab.setAttribute('aria-selected', 'true');
    }

    // Anunciar cambio para lectores de pantalla
    anunciarCambio(`Navegaste a: ${activeTab ? activeTab.textContent : sec}`);
  }

  // ========== SISTEMA DE NOTIFICACIONES (TOAST) ==========
  function mostrarToast(titulo, mensaje, tipo = 'success'){
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${tipo}`;
    toast.setAttribute('role', 'alert');
    
    const iconos = {
      success: '‚úÖ',
      error: '‚ùå',
      warning: '‚ö†Ô∏è',
      info: '‚ÑπÔ∏è'
    };
    
    toast.innerHTML = `
      <span class="toast-icon" aria-hidden="true">${iconos[tipo]}</span>
      <div class="toast-content">
        <div class="toast-title">${titulo}</div>
        <div class="toast-message">${mensaje}</div>
      </div>
    `;
    
    container.appendChild(toast);
    
    // Reproducir sonido si est√° activado
    if(configuracion.sonidos){
      reproducirSonido(tipo);
    }
    
    // Auto-remover despu√©s de 4 segundos
    setTimeout(() => {
      toast.style.opacity = '0';
      setTimeout(() => toast.remove(), 300);
    }, 4000);
  }

  // ========== VALIDACI√ìN DE FORMULARIOS ==========
  function validarCampo(input){
    const valor = input.value.trim();
    const id = input.id;
    const validationMsg = document.getElementById(`validation-${id.replace('in', '').toLowerCase()}`);
    
    if(!validationMsg) return;
    
    if(valor === '' && input.required){
      marcarInvalido(input, validationMsg, 'Este campo es obligatorio');
      return false;
    }
    
    marcarValido(input, validationMsg, '‚úì Correcto');
    actualizarProgreso();
    return true;
  }

  function validarRUT(input){
    const rut = input.value.replace(/\./g, '').replace(/-/g, '');
    const validationMsg = document.getElementById('validation-rut');
    
    if(rut.length < 8){
      marcarInvalido(input, validationMsg, 'El RUT debe tener al menos 8 d√≠gitos');
      return false;
    }
    
    // Validaci√≥n b√°sica de d√≠gito verificador
    const cuerpo = rut.slice(0, -1);
    const dv = rut.slice(-1).toUpperCase();
    
    let suma = 0;
    let multiplo = 2;
    
    for(let i = cuerpo.length - 1; i >= 0; i--){
      suma += parseInt(cuerpo[i]) * multiplo;
      multiplo = multiplo === 7 ? 2 : multiplo + 1;
    }
    
    const dvEsperado = 11 - (suma % 11);
    const dvCalculado = dvEsperado === 11 ? '0' : dvEsperado === 10 ? 'K' : String(dvEsperado);
    
    if(dv !== dvCalculado){
      marcarInvalido(input, validationMsg, 'El RUT ingresado no es v√°lido');
      return false;
    }
    
    marcarValido(input, validationMsg, '‚úì RUT v√°lido');
    return true;
  }

  function validarEmail(input){
    const email = input.value.trim();
    const validationMsg = document.getElementById('validation-correo');
    const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    if(!regex.test(email)){
      marcarInvalido(input, validationMsg, 'Ingresa un correo v√°lido (ejemplo@correo.cl)');
      return false;
    }
    
    marcarValido(input, validationMsg, '‚úì Correo v√°lido');
    return true;
  }

  function formatearRUT(input){
    let valor = input.value.replace(/[^0-9kK]/g, '');
    
    if(valor.length > 1){
      const cuerpo = valor.slice(0, -1);
      const dv = valor.slice(-1);
      valor = cuerpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.') + '-' + dv;
    }
    
    input.value = valor;
  }

  function marcarValido(input, msgElement, mensaje){
    input.classList.remove('invalid');
    input.classList.add('valid');
    input.setAttribute('aria-invalid', 'false');
    msgElement.className = 'validation-message success';
    msgElement.textContent = mensaje;
    msgElement.style.display = 'block';
  }

  function marcarInvalido(input, msgElement, mensaje){
    input.classList.remove('valid');
    input.classList.add('invalid');
    input.setAttribute('aria-invalid', 'true');
    msgElement.className = 'validation-message error';
    msgElement.textContent = mensaje;
    msgElement.style.display = 'block';
  }

  // ========== NAVEGACI√ìN POR PASOS ==========
  function siguientePaso(paso){
    // Validar paso actual antes de avanzar
    if(paso > currentStep){
      if(currentStep === 1 && !validarPaso1()) return;
      if(currentStep === 2 && !validarPaso2()) return;
    }
    
    // Ocultar todos los pasos
    for(let i = 1; i <= 3; i++){
      const step = document.getElementById(`step${i}`);
      if(step) step.style.display = 'none';
    }
    
    // Mostrar paso solicitado
    const stepElement = document.getElementById(`step${paso}`);
    if(stepElement){
      stepElement.style.display = 'block';
      stepElement.focus();
    }
    
    currentStep = paso;
    actualizarProgreso();
    
    // Anunciar para lectores de pantalla
    anunciarCambio(`Paso ${paso} de 3`);
  }

  function validarPaso1(){
    const nombre = document.getElementById('inNombre').value.trim();
    const rut = document.getElementById('inRut').value.trim();
    const correo = document.getElementById('inCorreo').value.trim();
    const telefono = document.getElementById('inTelefono').value.trim();
    
    if(!nombre || !rut || !correo || !telefono){
      mostrarToast('Campos incompletos', 'Por favor completa todos los campos obligatorios', 'warning');
      return false;
    }
    
    if(!validarRUT(document.getElementById('inRut'))){
      return false;
    }
    
    if(!validarEmail(document.getElementById('inCorreo'))){
      return false;
    }
    
    return true;
  }

  function validarPaso2(){
    // Paso 2 es opcional, siempre retorna true
    return true;
  }

  function actualizarProgreso(){
    const progreso = (currentStep / 3) * 100;
    const barraProgreso = document.getElementById('formProgress');
    const labelProgreso = document.getElementById('progressLabel');
    
    if(barraProgreso){
      barraProgreso.style.width = `${progreso}%`;
      barraProgreso.parentElement.setAttribute('aria-valuenow', progreso);
    }
    
    if(labelProgreso){
      labelProgreso.textContent = `Paso ${currentStep} de 3`;
    }
  }

  // ========== GUARDAR SOLICITUD ==========
  function guardarSolicitud(event){
    event.preventDefault();
    
    // Validar paso final
    const tipo = document.getElementById('inTipoSolicitud').value;
    const fecha = document.getElementById('inFecha').value;
    
    if(!tipo || !fecha){
      mostrarToast('Campos incompletos', 'Por favor completa el tipo de solicitud y la fecha', 'warning');
      return;
    }
    
    const btn = event.target;
    btn.disabled = true;
    btn.classList.add('loading');
    btn.textContent = 'Guardando...';
    
    // Simular guardado
    setTimeout(() => {
      const entrada = {
        fechaRegistro: new Date().toLocaleString('es-CL'),
        nombre: document.getElementById('inNombre').value,
        rut: document.getElementById('inRut').value,
        correo: document.getElementById('inCorreo').value,
        telefono: document.getElementById('inTelefono').value,
        animal: document.getElementById('inAnimalNombre').value || 'Por definir',
        microchip: document.getElementById('inMicrochip').value,
        tipo: tipo,
        fecha: fecha,
        obs: document.getElementById('inObs').value
      };
      
      entradas.push(entrada);
      actualizarEntradas();
      
      // Resetear formulario
      document.getElementById('adoptionForm').reset();
      siguientePaso(1);
      
      btn.disabled = false;
      btn.classList.remove('loading');
      btn.textContent = '‚úì Enviar Solicitud';
      
      mostrarToast(
        '¬°Solicitud enviada!', 
        'Recibir√°s un correo de confirmaci√≥n pronto. Te contactaremos para coordinar la visita.', 
        'success'
      );
      
      // Anunciar para lectores de pantalla
      anunciarCambio('Tu solicitud de adopci√≥n ha sido enviada exitosamente');
    }, 1500);
  }

  function actualizarEntradas(){
    if(entradas.length === 0){
      document.getElementById('entradaPreview').innerHTML = '<p class="muted">Completa el formulario para ver un resumen aqu√≠.</p>';
      return;
    }
    
    const ultima = entradas[entradas.length - 1];
    document.getElementById('entradaPreview').innerHTML = `
      <div style="background:#f0f9ff; padding:12px; border-radius:8px; border:1px solid #bae6fd;">
        <p><strong>üìÖ Fecha:</strong> ${ultima.fechaRegistro}</p>
        <p><strong>üë§ Adoptante:</strong> ${ultima.nombre}</p>
        <p><strong>üìß Correo:</strong> ${ultima.correo}</p>
        <p><strong>üêæ Mascota:</strong> ${ultima.animal}</p>
        <p><strong>üìù Tipo:</strong> ${ultima.tipo}</p>
        <p><strong>üìÜ Visita propuesta:</strong> ${ultima.fecha}</p>
      </div>
    `;
    
    // Actualizar tabla
    const tbody = document.getElementById('tablaEntradas');
    tbody.innerHTML = '';
    entradas.slice(-5).reverse().forEach(e => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${e.fechaRegistro}</td>
        <td>${e.nombre}</td>
        <td>${e.animal}</td>
        <td>${e.tipo}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ========== AUTO-GUARDADO ==========
  function autoGuardarFormulario(){
    if(!autoGuardarActivo) return;
    
    const datos = {
      nombre: document.getElementById('inNombre')?.value || '',
      rut: document.getElementById('inRut')?.value || '',
      correo: document.getElementById('inCorreo')?.value || '',
      telefono: document.getElementById('inTelefono')?.value || ''
    };
    
    localStorage.setItem('formularioTemp', JSON.stringify(datos));
    mostrarIndicadorGuardado();
  }

  function recuperarFormulario(){
    const guardado = localStorage.getItem('formularioTemp');
    if(guardado){
      try {
        const datos = JSON.parse(guardado);
        document.getElementById('inNombre').value = datos.nombre || '';
        document.getElementById('inRut').value = datos.rut || '';
        document.getElementById('inCorreo').value = datos.correo || '';
        document.getElementById('inTelefono').value = datos.telefono || '';
        mostrarToast('Datos recuperados', 'Hemos recuperado tu progreso anterior', 'info');
      } catch(e){
        console.error('Error al recuperar datos', e);
      }
    }
  }

  function mostrarIndicadorGuardado(){
    const indicador = document.getElementById('autoSaveIndicator');
    const icon = document.getElementById('saveIcon');
    const text = document.getElementById('saveText');
    
    indicador.style.display = 'flex';
    indicador.className = 'auto-save saving';
    icon.textContent = '‚è≥';
    text.textContent = 'Guardando...';
    
    setTimeout(() => {
      indicador.className = 'auto-save saved';
      icon.textContent = '‚úÖ';
      text.textContent = 'Guardado autom√°ticamente';
      
      setTimeout(() => {
        indicador.style.display = 'none';
      }, 2000);
    }, 500);
  }

  // Auto-guardar cada 10 segundos si hay cambios
  setInterval(() => {
    if(document.getElementById('entradas').classList.contains('hidden')) return;
    autoGuardarFormulario();
  }, 10000);

  // ========== CONFIGURACI√ìN Y ACCESIBILIDAD ==========
  function cambiarTamanoTexto(valor){
    document.documentElement.style.fontSize = `${valor}px`;
    document.getElementById('outputTexto').textContent = `${valor}px`;
    configuracion.tamanoTexto = parseInt(valor);
  }

  function toggleModoSimple(activo){
    if(activo){
      document.body.classList.add('modo-simple');
      mostrarToast('Modo simplificado', 'Textos m√°s grandes y menos opciones activadas', 'success');
    } else {
      document.body.classList.remove('modo-simple');
      mostrarToast('Modo normal', 'Interfaz est√°ndar restaurada', 'success');
    }
    configuracion.modoSimple = activo;
  }

  function toggleAnimaciones(activo){
    if(!activo){
      document.body.style.setProperty('--transition-duration', '0ms');
    } else {
      document.body.style.removeProperty('--transition-duration');
    }
    configuracion.animaciones = activo;
  }

  function toggleSonidos(activo){
    configuracion.sonidos = activo;
    if(activo){
      mostrarToast('Sonidos activados', 'Recibir√°s notificaciones sonoras', 'success');
    }
  }

  function toggleAutoGuardar(activo){
    autoGuardarActivo = activo;
    configuracion.autoGuardar = activo;
    mostrarToast(
      activo ? 'Auto-guardado activado' : 'Auto-guardado desactivado',
      activo ? 'Tu progreso se guardar√° autom√°ticamente' : 'Deber√°s guardar manualmente',
      'info'
    );
  }

  function guardarConfiguracion(){
    localStorage.setItem('configuracionAccesibilidad', JSON.stringify(configuracion));
    mostrarToast('Configuraci√≥n guardada', 'Tus preferencias se aplicar√°n en futuras visitas', 'success');
  }

  function cargarConfiguracion(){
    const guardada = localStorage.getItem('configuracionAccesibilidad');
    if(guardada){
      try {
        const config = JSON.parse(guardada);
        configuracion = config;
        
        // Aplicar configuraci√≥n
        cambiarTamanoTexto(config.tamanoTexto);
        document.getElementById('rangeTexto').value = config.tamanoTexto;
        
        if(config.modoSimple){
          document.getElementById('checkModoSimple').checked = true;
          toggleModoSimple(true);
        }
        
        document.getElementById('checkAnimaciones').checked = config.animaciones;
        toggleAnimaciones(config.animaciones);
        
        document.getElementById('checkSonidos').checked = config.sonidos;
        document.getElementById('checkAutoGuardar').checked = config.autoGuardar;
        autoGuardarActivo = config.autoGuardar;
        
        mostrarToast('Preferencias cargadas', 'Tus configuraciones han sido aplicadas', 'info');
      } catch(e){
        console.error('Error al cargar configuraci√≥n', e);
      }
    }
  }

  // ========== ACCESIBILIDAD - ANUNCIOS PARA SCREEN READERS ==========
  function anunciarCambio(mensaje){
    const anunciador = document.getElementById('sr-announcer') || crearAnunciador();
    anunciador.textContent = mensaje;
    
    // Limpiar despu√©s de 1 segundo
    setTimeout(() => {
      anunciador.textContent = '';
    }, 1000);
  }

  function crearAnunciador(){
    const div = document.createElement('div');
    div.id = 'sr-announcer';
    div.className = 'sr-only';
    div.setAttribute('role', 'status');
    div.setAttribute('aria-live', 'polite');
    div.setAttribute('aria-atomic', 'true');
    document.body.appendChild(div);
    return div;
  }

  function reproducirSonido(tipo){
    // Simulaci√≥n de sonido (en producci√≥n usar√≠as Web Audio API o archivos de audio)
    if(!configuracion.sonidos) return;
    
    const frecuencias = {
      success: 800,
      error: 400,
      warning: 600,
      info: 700
    };
    
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = frecuencias[tipo] || 700;
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.3);
    } catch(e){
      console.error('Error al reproducir sonido', e);
    }
  }

  // ========== MODAL ==========
  function closeModal(){
    const modal = document.getElementById('modal');
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
  }

  // Cerrar modal con tecla Escape
  document.addEventListener('keydown', (e) => {
    if(e.key === 'Escape'){
      closeModal();
    }
  });

  // ========== INICIALIZACI√ìN ==========
  document.addEventListener('DOMContentLoaded', () => {
    // Establecer fecha m√≠nima como hoy
    const hoy = new Date().toISOString().split('T')[0];
    const inputFecha = document.getElementById('inFecha');
    if(inputFecha) inputFecha.min = hoy;
    
    // Recuperar formulario si existe
    recuperarFormulario();
    
    // Inicializar progreso
    actualizarProgreso();
  });
</script>

</body>
</html>
