<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bonnie SIRA ‚Äî Prototipo (Salidas + Carro Webpay)</title>
  <style>
    :root{
      --lav:#7a77ff;
      --lav-2:#a6a3ff;
      --cel:#7fd3ff;
      --bg:#f6f7ff;
      --card:#ffffff;
      --ink:#1f2230;
      --muted:#6b6f86;
      --line:#eceefe;
      --radius:16px;
      --shadow:0 10px 30px rgba(35,38,90,.08);
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
    body{margin:0;background:var(--bg);color:var(--ink);}
    a{color:inherit;text-decoration:none;}
    header{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(90deg,var(--lav),var(--cel));
      color:#fff;padding:14px 18px;box-shadow:0 6px 20px rgba(0,0,0,.12);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.3px;}
    .paw{
      width:34px;height:34px;border-radius:10px;background:rgba(255,255,255,.18);
      display:grid;place-items:center;font-size:18px;
      backdrop-filter: blur(4px);
    }
    nav{display:flex;gap:8px;flex-wrap:wrap;}
    nav button{
      border:0;background:rgba(255,255,255,.14);color:#fff;
      padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:700;
      transition:.2s;display:flex;align-items:center;gap:6px;
    }
    nav button.active{background:#fff;color:var(--lav);}
    nav button:hover{transform:translateY(-1px);background:rgba(255,255,255,.22);}

    .wrap{max-width:1100px;margin:18px auto;padding:0 14px 60px;}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;}
    .card{
      background:var(--card);border:1px solid var(--line);
      border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;
    }
    h2{font-size:18px;margin:0 0 10px;}
    h3{font-size:15px;margin:6px 0;color:#343853;}
    .muted{color:var(--muted);font-size:13px;}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;
      background:#f2f3ff;color:#40446a;font-weight:700;border:1px solid var(--line);}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
    .spacer{height:8px;}
    .btn{
      border:0;background:var(--lav);color:#fff;padding:9px 12px;border-radius:12px;cursor:pointer;font-weight:800;
      transition:.15s;box-shadow:0 6px 14px rgba(122,119,255,.35);
    }
    .btn:hover{transform:translateY(-1px);filter:saturate(1.05);}
    .btn.secondary{background:#eef0ff;color:#3a3f63;box-shadow:none;border:1px solid var(--line);}
    .btn.ghost{background:transparent;color:var(--lav);border:2px solid var(--lav);box-shadow:none;}
    .btn.small{padding:6px 9px;border-radius:10px;font-size:12px;}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none;}

    .product{
      display:flex;gap:12px;align-items:center;border:1px dashed var(--line);
      padding:10px;border-radius:14px;background:#fbfbff;
    }
    .pimg{
      width:62px;height:62px;border-radius:14px;
      background:linear-gradient(160deg,#fff,#eef0ff);
      display:grid;place-items:center;font-size:26px;
      border:1px solid var(--line);
    }
    .price{font-weight:900;}
    .tag{font-size:11px;font-weight:800;padding:3px 7px;border-radius:9px;background:#e9fff2;color:#0a7d3b;border:1px solid #c9f0d8;}
    .tag.warn{background:#fff7e9;color:#915f00;border-color:#f2d8a8;}

    table{width:100%;border-collapse:collapse;}
    th,td{padding:9px;border-bottom:1px solid var(--line);font-size:14px;}
    th{color:var(--muted);text-align:left;font-weight:800;}
    .right{text-align:right;}

    input,select,textarea{
      width:100%;padding:9px;border-radius:12px;border:1px solid #dfe2fb;background:#fcfcff;
      outline:none;transition:.15s;
    }
    input:focus,select:focus,textarea:focus{border-color:var(--lav-2);box-shadow:0 0 0 4px rgba(122,119,255,.12);}

    section.hidden{display:none;}

    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,16,30,.5);z-index:99;}
    .dialog{background:white;width:min(560px,92vw);border-radius:18px;padding:14px;border:1px solid var(--line);box-shadow:0 20px 60px rgba(0,0,0,.25);}
    .dialog header{position:unset;background:transparent;color:var(--ink);box-shadow:none;padding:0;display:flex;justify-content:space-between;}
    .x{border:0;background:transparent;font-size:22px;cursor:pointer;}
    .code{background:#0b1020;color:#e9f1ff;padding:10px;border-radius:12px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;overflow:auto;}

    footer{color:var(--muted);font-size:12px;text-align:center;margin-top:14px;}

    @media (max-width:800px){ .grid{grid-template-columns:repeat(6,1fr);} }
    @media (max-width:520px){
      .grid{grid-template-columns:repeat(2,1fr);}
      nav{gap:6px;}
    }
  </style>
</head>
<body>

<header>
  <div class="brand">
    <div class="paw">üêæ</div>
    <div>
      <div>Bonnie SIRA</div>
      <div class="muted" style="color:#eef;">Refugio & Adopciones</div>
    </div>
  </div>
  <nav>
    <button id="tab-home" class="active" onclick="show('home')">üè† Inicio</button>
    <button id="tab-tienda" onclick="show('tienda')">üõçÔ∏è Tienda/Donar</button>
    <button id="tab-carro" onclick="show('carro')">üß∫ Carro <span id="badge" class="chip" style="background:#fff;color:var(--lav);">0</span></button>
    <button id="tab-salidas" onclick="show('salidas')">üìÑ Salidas</button>
    <button id="tab-especificacion" onclick="show('especificacion')">‚úÖ Justificaci√≥n</button>
  </nav>
</header>

<div class="wrap">

  <!-- HOME -->
  <section id="home" class="card">
    <h2>Bienvenida ‚ú®</h2>
    <p class="muted">Prototipo de salidas del sistema Bonnie SIRA + carro de compras con integraci√≥n Webpay simulada.</p>
    <div class="spacer"></div>
    <div class="grid">
      <div class="card" style="grid-column:span 4;">
        <h3>Adopta con confianza</h3>
        <p class="muted">Solicita adopci√≥n, agenda visita y recibe tu contrato digital.</p>
        <div class="row"><span class="chip">Comprobante</span><span class="chip">Contrato</span></div>
        <div class="spacer"></div>
        <button class="btn" onclick="show('salidas')">Ver documentos</button>
      </div>
      <div class="card" style="grid-column:span 4;">
        <h3>Cuida su salud</h3>
        <p class="muted">Ficha cl√≠nica, vacunaci√≥n y alertas de control.</p>
        <div class="row"><span class="chip">Hoja vacunaci√≥n</span><span class="chip">Ficha cl√≠nica</span></div>
        <div class="spacer"></div>
        <button class="btn secondary" onclick="show('salidas')">Ver salidas cl√≠nicas</button>
      </div>
      <div class="card" style="grid-column:span 4;">
        <h3>Apoya al refugio</h3>
        <p class="muted">Compra insumos o dona con Webpay. Recibes boleta por mail.</p>
        <div class="row"><span class="chip">Carro</span><span class="chip">Webpay</span></div>
        <div class="spacer"></div>
        <button class="btn ghost" onclick="show('tienda')">Ir a tienda</button>
      </div>
    </div>
  </section>

  <!-- TIENDA / DONAR -->
  <section id="tienda" class="hidden">
    <div class="grid">
      <div class="card" style="grid-column:span 8;">
        <h2>Tienda solidaria üõçÔ∏è</h2>
        <p class="muted">Cat√°logo web con compras/donaciones.</p>
        <div class="spacer"></div>

        <div class="product">
          <div class="pimg">ü•´</div>
          <div style="flex:1;">
            <div class="row">
              <strong>Pack alimento 10kg</strong>
              <span class="tag">Insumo</span>
            </div>
            <div class="muted">Para perritos grandes.</div>
          </div>
          <div class="right">
            <div class="price">$24.990</div>
            <button class="btn small" onclick="addItem('Pack alimento 10kg', 24990)">Agregar</button>
          </div>
        </div>

        <div class="spacer"></div>

        <div class="product">
          <div class="pimg">üíâ</div>
          <div style="flex:1;">
            <div class="row">
              <strong>Vacuna anual</strong>
              <span class="tag warn">Campa√±a</span>
            </div>
            <div class="muted">Aporta a la vacunaci√≥n masiva.</div>
          </div>
          <div class="right">
            <div class="price">$8.000</div>
            <button class="btn small" onclick="addItem('Aporte vacuna anual', 8000)">Agregar</button>
          </div>
        </div>

        <div class="spacer"></div>

        <div class="product">
          <div class="pimg">üê∂</div>
          <div style="flex:1;">
            <div class="row">
              <strong>Cuota de adopci√≥n</strong>
              <span class="tag">Adopci√≥n</span>
            </div>
            <div class="muted">Cubre microchip + desparasitaci√≥n.</div>
          </div>
          <div class="right">
            <div class="price">$19.900</div>
            <button class="btn small" onclick="addItem('Cuota de adopci√≥n', 19900)">Agregar</button>
          </div>
        </div>

        <div class="spacer"></div>

        <div class="product">
          <div class="pimg">üéÄ</div>
          <div style="flex:1;">
            <div class="row">
              <strong>Sticker Bonnie Berta (x5)</strong>
              <span class="tag">Merch</span>
            </div>
            <div class="muted">Pack de 5 stickers.</div>
          </div>
          <div class="right">
            <div class="price">$3.990</div>
            <button class="btn small" onclick="addItem('Sticker Bonnie Berta (x5)', 3990)">Agregar</button>
          </div>
        </div>

      </div>

      <div class="card" style="grid-column:span 4;">
        <h2>Resumen r√°pido</h2>
        <p class="muted">Pagas con Webpay simulado y generas boleta PDF.</p>
        <div class="spacer"></div>
        <div class="row">
          <button class="btn" onclick="show('carro')">Ir al carro</button>
          <button class="btn secondary" onclick="addDemo()">Agregar demo</button>
        </div>
      </div>
    </div>
  </section>

  <!-- CARRO -->
  <section id="carro" class="hidden">
    <div class="grid">
      <div class="card" style="grid-column:span 8;">
        <h2>Carro de compras üß∫</h2>
        <p class="muted">Checkout con Webpay (mock).</p>

        <table id="cartTable">
          <thead>
            <tr><th>√çtem</th><th class="right">Precio</th><th class="right">Cant.</th><th class="right">Subtotal</th><th></th></tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr><td colspan="3" class="right">Subtotal</td><td class="right" id="subtotal">$0</td><td></td></tr>
            <tr><td colspan="3" class="right">IVA 19%</td><td class="right" id="tax">$0</td><td></td></tr>
            <tr><td colspan="3" class="right"><strong>Total</strong></td><td class="right" id="total"><strong>$0</strong></td><td></td></tr>
          </tfoot>
        </table>

        <div class="spacer"></div>
        <div class="row">
          <button class="btn ghost" onclick="clearCart()">Vaciar carro</button>
          <button class="btn" onclick="openWebpay()">Pagar con Webpay</button>
        </div>
      </div>

      <div class="card" style="grid-column:span 4;">
        <h2>Datos del comprador</h2>
        <label>Nombre y Apellido</label>
        <input id="buyerName" placeholder="Ej: B√°rbara Valenzuela"/>
        <label>Email</label>
        <input id="buyerEmail" placeholder="ejemplo@correo.cl"/>
        <label>Tipo de aporte</label>
        <select id="purchaseType">
          <option value="donacion">Donaci√≥n</option>
          <option value="tienda">Compra tienda</option>
          <option value="adopcion">Cuota adopci√≥n</option>
        </select>
        <div class="spacer"></div>
        <p class="muted">Campos requeridos con validaci√≥n b√°sica.</p>
      </div>
    </div>
  </section>

  <!-- SALIDAS -->
  <section id="salidas" class="hidden card">
    <h2>Salidas del sistema üìÑ</h2>
    <p class="muted">Documentos y reportes exportables (mock).</p>

    <div class="grid">
      <div class="card" style="grid-column:span 6;">
        <h3>Comprobante de adopci√≥n</h3>
        <p class="muted">Resumen de entrega + firma digital.</p>
        <div class="row">
          <button class="btn" onclick="previewDoc('Comprobante de adopci√≥n')">Vista previa</button>
          <button class="btn secondary"
  onclick="downloadPDF(
    'Comprobante_Adopcion.pdf',
    'Comprobante de adopci√≥n',
    [
      'Folio: CA-000234',
      'Adoptante: Nombre Apellido (RUT xx.xxx.xxx-x)',
      'Animal: Bonnie (Canina, 2 a√±os, microchip 12345)',
      '',
      'Cl√°usulas principales:',
      '‚Ä¢ Cuidado responsable y controles veterinarios.',
      '‚Ä¢ Prohibici√≥n de abandono o maltrato.',
      '‚Ä¢ Seguimiento post-adopci√≥n por 6 meses.',
      '',
      'Firmas:',
      'Adoptante: ____________________',
      'Refugio: ______________________'
    ]
  )">
  Exportar PDF
</button>

        </div>
      </div>

      <div class="card" style="grid-column:span 6;">
        <h3>Contrato de adopci√≥n</h3>
        <p class="muted">Cl√°usulas y obligaciones.</p>
        <div class="row">
          <button class="btn" onclick="previewDoc('Contrato de adopci√≥n')">Vista previa</button>
          <button class="btn secondary"
  onclick="downloadPDF(
    'Contrato_Adopcion.pdf',
    'Contrato de adopci√≥n',
    [
      'Folio: CA-000234',
      'Adoptante: Nombre Apellido (RUT xx.xxx.xxx-x)',
      'Animal: Bonnie (Canina, 2 a√±os, microchip 12345)',
      '',
      'Cl√°usulas principales:',
      '‚Ä¢ Cuidado responsable y controles veterinarios.',
      '‚Ä¢ Prohibici√≥n de abandono o maltrato.',
      '‚Ä¢ Seguimiento post-adopci√≥n por 6 meses.',
      '',
      'Firmas:',
      'Adoptante: ____________________',
      'Refugio: ______________________'
    ]
  )">
  Exportar PDF
</button>

        </div>
      </div>

      <div class="card" style="grid-column:span 6;">
        <h3>Hoja de vacunaci√≥n</h3>
        <p class="muted">Aplicadas + pr√≥ximas dosis.</p>
        <div class="row">
          <button class="btn" onclick="previewDoc('Hoja de vacunaci√≥n')">Vista previa</button>
          <button class="btn secondary"
  onclick="downloadPDF(
    'Hoja_Vacunaci√≥n.pdf',
    'Hoja de Vacunaci√≥n',
    [
      'Folio: CA-000234',
      'Adoptante: Nombre Apellido (RUT xx.xxx.xxx-x)',
      'Animal: Bonnie (Canina, 2 a√±os, microchip 12345)',
      '',
      'Cl√°usulas principales:',
      '‚Ä¢ Cuidado responsable y controles veterinarios.',
      '‚Ä¢ Prohibici√≥n de abandono o maltrato.',
      '‚Ä¢ Seguimiento post-adopci√≥n por 6 meses.',
      '',
      'Firmas:',
      'Adoptante: ____________________',
      'Refugio: ______________________'
    ]
  )">
  Exportar PDF
</button>

        </div>
      </div>

      <div class="card" style="grid-column:span 6;">
        <h3>Informe visita domiciliaria</h3>
        <p class="muted">Checklist + evidencias.</p>
        <div class="row">
          <button class="btn" onclick="previewDoc('Informe visita domiciliaria')">Vista previa</button>
          <button class="btn secondary"
  onclick="downloadPDF(
    'Informe_Visita.pdf',
    'Informe de Visita',
    [
      'Folio: CA-000234',
      'Adoptante: Nombre Apellido (RUT xx.xxx.xxx-x)',
      'Animal: Bonnie (Canina, 2 a√±os, microchip 12345)',
      '',
      'Cl√°usulas principales:',
      '‚Ä¢ Cuidado responsable y controles veterinarios.',
      '‚Ä¢ Prohibici√≥n de abandono o maltrato.',
      '‚Ä¢ Seguimiento post-adopci√≥n por 6 meses.',
      '',
      'Firmas:',
      'Adoptante: ____________________',
      'Refugio: ______________________'
    ]
  )">
  Exportar PDF
</button>

        </div>
      </div>

      <div class="card" style="grid-column:span 6;">
        <h3>Boleta / Comprobante Webpay</h3>
        <p class="muted">Se genera tras pago autorizado.</p>
        <div class="row">
          <button class="btn" onclick="previewDoc('Boleta / Comprobante Webpay')">Vista previa</button>
          <button class="btn secondary"
  onclick="downloadPDF(
    'Boleta_Webpay.pdf',
    'Boleta de compra',
    [
      'Folio: CA-000234',
      'Comprador: Nombre Apellido (RUT xx.xxx.xxx-x)',
      'Animal: Bonnie (Canina, 2 a√±os, microchip 12345)',
      '',
      'Cl√°usulas principales:',
      '‚Ä¢ Cuidado responsable y controles veterinarios.',
      '‚Ä¢ Prohibici√≥n de abandono o maltrato.',
      '‚Ä¢ Seguimiento post-adopci√≥n por 6 meses.',
      '',
      'Firmas:',
      'Adoptante: ____________________',
      'Refugio: ______________________'
    ]
  )">
  Exportar PDF
</button>

        </div>
      </div>

      <div class="card" style="grid-column:span 6;">
        <h3>Reportes de gesti√≥n (CSV)</h3>
        <p class="muted">KPI adopciones y donaciones.</p>
        <div class="row">
          <button class="btn" onclick="previewDoc('Reporte de gesti√≥n')">Vista previa</button>
          <button class="btn secondary"
  onclick="downloadPDF(
    'Repoprte_Gesti√≥n.pdf',
    'Reporte de Gesti√≥n',
    [
      'Folio: CA-000234',
      'Adoptante: Nombre Apellido (RUT xx.xxx.xxx-x)',
      'Animal: Bonnie (Canina, 2 a√±os, microchip 12345)',
      '',
      'Cl√°usulas principales:',
      '‚Ä¢ Cuidado responsable y controles veterinarios.',
      '‚Ä¢ Prohibici√≥n de abandono o maltrato.',
      '‚Ä¢ Seguimiento post-adopci√≥n por 6 meses.',
      '',
      'Firmas:',
      'Adoptante: ____________________',
      'Refugio: ______________________'
    ]
  )">
  Exportar PDF
</button>

        </div>
      </div>
    </div>
  </section>

  <!-- JUSTIFICACI√ìN -->
  <section id="especificacion" class="hidden card">
    <h2>Justificaci√≥n y especificaci√≥n ‚úÖ</h2>
    <div class="grid">
      <div class="card" style="grid-column:span 6;">
        <h3>Justificaci√≥n</h3>
        <ul class="muted">
          <li><b>Contrato y comprobante:</b> respaldo legal y trazabilidad.</li>
          <li><b>Hoja de vacunaci√≥n:</b> continuidad cl√≠nica y alertas.</li>
          <li><b>Informe visita:</b> evidencia para aprobaci√≥n/rechazo.</li>
          <li><b>Boleta Webpay:</b> obligaci√≥n tributaria.</li>
          <li><b>Reportes:</b> KPI para gesti√≥n del refugio.</li>
        </ul>
      </div>
      <div class="card" style="grid-column:span 6;">
        <h3>Especificaci√≥n</h3>
        <ul class="muted">
          <li><b>Formato:</b> PDF y CSV.</li>
          <li><b>Contenido:</b> folio, fecha/hora, IDs, firma digital, QR/hash.</li>
          <li><b>Rendimiento:</b> generaci√≥n &lt; 2s.</li>
          <li><b>Seguridad:</b> acceso por rol + bit√°cora.</li>
          <li><b>Webpay:</b> PENDING/AUTHORIZED/FAILED; pospago env√≠a PDF.</li>
        </ul>
      </div>
    </div>
  </section>

  <footer>Prototipo educativo ¬∑ Cute minimal ¬∑ Bonnie SIRA ¬©</footer>
</div>

<!-- Modal documento -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="dialog">
    <header>
      <h3 id="modalTitle">Documento</h3>
      <button class="x" onclick="closeModal()">√ó</button>
    </header>
    <div id="modalBody" class="muted"></div>
    <div class="spacer"></div>
    <div class="row">
      <button class="btn secondary" onclick="closeModal()">Cerrar</button>
      <button class="btn secondary"
  onclick="downloadPDF(
    'Contrato_Adopcion.pdf',
    'Contrato de adopci√≥n',
    [
      'Folio: CA-000234',
      'Adoptante: Nombre Apellido (RUT xx.xxx.xxx-x)',
      'Animal: Bonnie (Canina, 2 a√±os, microchip 12345)',
      '',
      'Cl√°usulas principales:',
      '‚Ä¢ Cuidado responsable y controles veterinarios.',
      '‚Ä¢ Prohibici√≥n de abandono o maltrato.',
      '‚Ä¢ Seguimiento post-adopci√≥n por 6 meses.',
      '',
      'Firmas:',
      'Adoptante: ____________________',
      'Refugio: ______________________'
    ]
  )">
  Exportar PDF
</button>

    </div>
  </div>
</div>

<!-- Modal Webpay -->
<div id="webpay" class="modal" aria-hidden="true">
  <div class="dialog">
    <header>
      <h3>Webpay (Simulaci√≥n)</h3>
      <button class="x" onclick="closeWebpay()">√ó</button>
    </header>
    <p class="muted">Sandbox simulado. No procesa pagos reales.</p>
    <div class="grid">
      <div style="grid-column:span 6;">
        <label>N√∫mero de tarjeta</label>
        <input placeholder="xxxx xxxx xxxx xxxx"/>
      </div>
      <div style="grid-column:span 3;">
        <label>Expira</label>
        <input placeholder="mm/aa"/>
      </div>
      <div style="grid-column:span 3;">
        <label>CVV</label>
        <input placeholder="123"/>
      </div>
      <div style="grid-column:span 12;">
        <label>Nombre titular</label>
        <input placeholder="Titular demo"/>
      </div>
    </div>
    <div class="spacer"></div>
    <div class="row">
      <button class="btn secondary" onclick="confirmWebpay(false)">Cancelar</button>
      <button class="btn" onclick="confirmWebpay(true)">Autorizar pago</button>
    </div>
  </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


<script>
  const sections = ['home','tienda','carro','salidas','especificacion'];
  function show(id){
    sections.forEach(s=>{
      document.getElementById(s).classList.toggle('hidden', s!==id);
      document.getElementById('tab-'+s).classList.toggle('active', s===id);
    });
    window.scrollTo({top:0,behavior:'smooth'});
  }

  const cart = [];
  const badge = document.getElementById('badge');
  function money(n){ return new Intl.NumberFormat('es-CL',{style:'currency',currency:'CLP'}).format(n); }
  function syncBadge(){ badge.textContent = cart.reduce((a,i)=>a+i.qty,0); }

  function addItem(name, price){
    const it = cart.find(i=>i.name===name);
    it ? it.qty++ : cart.push({name, price, qty:1});
    renderCart(); syncBadge();
  }
  function addDemo(){ addItem('Pack alimento 10kg', 24990); addItem('Aporte vacuna anual', 8000); }
  function removeItem(name){ const idx = cart.findIndex(i=>i.name===name); if(idx>-1) cart.splice(idx,1); renderCart(); syncBadge(); }
  function changeQty(name, q){
    const it = cart.find(i=>i.name===name); if(!it) return;
    it.qty = Math.max(1, parseInt(q||'1',10)); renderCart(); syncBadge();
  }
  function clearCart(){ cart.splice(0, cart.length); renderCart(); syncBadge(); }

  function renderCart(){
    const tbody = document.querySelector('#cartTable tbody');
    tbody.innerHTML = '';
    let sub = 0;
    cart.forEach(it=>{
      const st = it.price*it.qty; sub += st;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${it.name}</td>
        <td class="right">${money(it.price)}</td>
        <td class="right"><input type="number" min="1" value="${it.qty}" style="width:70px" onchange="changeQty('${it.name}', this.value)"></td>
        <td class="right">${money(st)}</td>
        <td class="right"><button class="btn secondary small" onclick="removeItem('${it.name}')">Quitar</button></td>`;
      tbody.appendChild(tr);
    });
    const tax = Math.round(sub*0.19);
    const total = sub+tax;
    document.getElementById('subtotal').textContent = money(sub);
    document.getElementById('tax').textContent = money(tax);
    document.getElementById('total').innerHTML = `<strong>${money(total)}</strong>`;
  }

  function previewDoc(title){
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = `
      <p><b>${title}</b> (mock).</p>
      <ul>
        <li>Folio/ID, fecha y hora</li>
        <li>Datos clave (animal, adoptante/usuario)</li>
        <li>QR/Hash de verificaci√≥n</li>
        <li>Firma digital</li>
      </ul>`;
    document.getElementById('modal').style.display='flex';
  }
  function closeModal(){ document.getElementById('modal').style.display='none'; }

  function downloadPDF(fileName, title, bodyLines = []) {
  // Verifica que jsPDF est√© cargado
  if (!window.jspdf || !window.jspdf.jsPDF) {
    alert("No se carg√≥ jsPDF. Revisa tu conexi√≥n o el link CDN.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // Encabezado
  doc.setFont("helvetica", "bold");
  doc.setFontSize(16);
  doc.text("Bonnie SIRA ‚Äî Refugio & Adopciones", 14, 18);

  doc.setFontSize(12);
  doc.setFont("helvetica", "normal");
  doc.text(title, 14, 30);

  // Fecha
  const now = new Date();
  doc.setFontSize(10);
  doc.text(`Fecha emisi√≥n: ${now.toLocaleString("es-CL")}`, 14, 38);

  // Cuerpo
  let y = 50;
  doc.setFontSize(11);

  if (bodyLines.length === 0) {
    bodyLines = [
      "Documento generado por prototipo educativo.",
      "Incluye datos simulados.",
      "",
      "Elementos m√≠nimos:",
      "‚Ä¢ Folio/ID",
      "‚Ä¢ Fecha y hora",
      "‚Ä¢ Identificaci√≥n animal/adoptante",
      "‚Ä¢ QR/Hash de verificaci√≥n",
      "‚Ä¢ Firma digital",
    ];
  }

  bodyLines.forEach(line => {
    doc.text(line, 14, y);
    y += 7;
    if (y > 280) { doc.addPage(); y = 20; }
  });

  // Guardar
  doc.save(fileName);
}

function downloadCSV(fileName, csvText) {
  const blob = new Blob([csvText], { type: "text/csv;charset=utf-8;" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  a.click();
  URL.revokeObjectURL(a.href);
}


  function openWebpay(){
    if(cart.length===0){ alert('Tu carro est√° vac√≠o.'); return; }
    const name = document.getElementById('buyerName').value.trim();
    const email = document.getElementById('buyerEmail').value.trim();
    if(!name || !email){ alert('Completa Nombre y Email para continuar.'); return; }
    document.getElementById('webpay').style.display='flex';
  }
  function closeWebpay(){ document.getElementById('webpay').style.display='none'; }
  function confirmWebpay(ok){
    closeWebpay();
    if(ok){
      alert('Pago autorizado (simulaci√≥n). Se gener√≥ Boleta/Comprobante.');
      fakeDownload('Boleta_Webpay.pdf'); clearCart();
    }else{ alert('Pago cancelado (simulaci√≥n).'); }
  }

  renderCart(); syncBadge();
</script>

</body>
</html>
